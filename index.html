<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E3260">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medi Clicks - Dashboard Dinámico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.6.1/build/vanilla-js-calendar.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Favicon Links (Asegúrate que estos archivos existan en la carpeta /images/) -->
   <link rel="icon" href="images/favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png">

    <script>    
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'brand-bg-main-start': '#EFF6FF', 'brand-bg-main-end': '#DBEAFE', 'brand-sidebar': '#1E3A8A',
                        'brand-sidebar-hover': '#1D4ED8', 
                        'brand-primary': '#1E3260', 
                        'brand-primary-hover': '#162649',
                        'brand-primary-active': '#0F1A33',
                        'brand-text-primary': '#1E293B', 'brand-text-secondary': '#475569',
                        'brand-text-sidebar': '#E0F2FE', 'brand-border-light': '#BFDBFE', 
                        'brand-border-focus': '#1E3260', 
                        'brand-white': '#FFFFFF', 'brand-light-bg': '#F9FAFB',
                        'success': '#10B981', 'info': '#3B82F6', 'warning': '#F59E0B', 'danger': '#EF4444',
                        primary: { 
                            light: '#5170A7', 
                            DEFAULT: '#1E3260', 
                            dark: '#162649', 
                            darker: '#0F1A33' 
                        },
                        secondary: '#EFF6FF', lightgray: '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --color-brand-bg-main-start: #EFF6FF; --color-brand-bg-main-end: #DBEAFE; --color-brand-sidebar: #1E3A8A;
            --color-brand-sidebar-hover: #1D4ED8; 
            --color-brand-primary: #1E3260;
            --color-brand-primary-hover: #162649; 
            --color-brand-primary-active: #0F1A33; 
            --color-brand-text-primary: #1E293B; --color-brand-text-secondary: #475569;
            --color-brand-text-sidebar: #E0F2FE; --color-brand-border-light: #BFDBFE; 
            --color-brand-border-focus: #1E3260; 
            --color-brand-white: #FFFFFF; --color-brand-light-bg: #F9FAFB;
            --shadow-soft: 0px 4px 10px rgba(0,0,0,0.08); --shadow-medium: 0px 6px 15px rgba(30,58,138,0.12); --shadow-strong: 0px 8px 25px rgba(30,58,138,0.15);
            --border-radius-small: 0.375rem; --border-radius-medium: 0.5rem; --border-radius-large: 0.75rem; --border-radius-xl: 1rem;
        }
        html.dark {
            --color-brand-bg-main-start: #1F2937; 
            --color-brand-bg-main-end: #111827;   
            --color-brand-sidebar: #1E3A8A;       
            --color-brand-sidebar-hover: #1D4ED8; 
            --color-brand-primary: #5170A7;       
            --color-brand-primary-hover: #6A89C1;
            --color-brand-primary-active: #3C5A8E;
            --color-brand-text-primary: #F3F4F6;  
            --color-brand-text-secondary: #9CA3AF;
            --color-brand-text-sidebar: #E0F2FE;  
            --color-brand-border-light: #374151;  
            --color-brand-border-focus: #5170A7; 
            --color-brand-white: #111827;         
            --color-brand-light-bg: #1F2937;      

            --shadow-soft: 0px 4px 10px rgba(0,0,0,0.3);
            --shadow-medium: 0px 6px 15px rgba(0,0,0,0.35);
            --shadow-strong: 0px 8px 25px rgba(0,0,0,0.4);
        }

        html { scroll-behavior: smooth; }
        body { display: flex; min-height: 100vh; font-family: 'Inter', sans-serif; color: var(--color-brand-text-primary); background-color: var(--color-brand-bg-main-start); } 
        
        #loginScreen { display: none; }
        .content-wrapper { display: none; flex-grow: 1; width: 100%; }

        aside {
            height: 100vh;
            flex-shrink: 0;
            background-color: var(--color-brand-sidebar);
            color: var(--color-brand-text-sidebar);
            box-shadow: var(--shadow-medium);
            transition: transform 0.3s ease-in-out;
        }
        aside.fixed { z-index: 40; }
        @media (min-width: 1024px) { 
            aside { position: sticky; top: 0; transform: translateX(0) !important; }
        }

        main { flex-grow: 1; height: 100vh; overflow-y: auto; background-image: linear-gradient(145deg, var(--color-brand-bg-main-start), var(--color-brand-bg-main-end)); transition: margin-left 0.3s ease-in-out; }
        aside .border-b { border-color: rgba(255,255,255,0.1); } 
        aside .sidebar-logo-container img { display: block; margin-left: auto; margin-right: auto; } 
        aside .sidebar-logo-container p { color: var(--color-brand-text-sidebar); }

        .nav-link { color: var(--color-brand-text-sidebar); border-radius: var(--border-radius-medium); transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; } .nav-link:hover { background-color: var(--color-brand-sidebar-hover); color: var(--color-brand-white); transform: translateX(2px); } .nav-link.active { background-color: var(--color-brand-primary); color: var(--color-brand-white); font-weight: 600; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); } .nav-link svg { stroke: currentColor; }
        main h2.text-2xl, main h2.text-3xl { color: var(--color-brand-text-primary); font-weight: 600; } main h3 { color: var(--color-brand-text-primary); }
        .content-card-modern, .dashboard-card { background-color: var(--color-brand-white); border-radius: var(--border-radius-large); box-shadow: var(--shadow-soft); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; } .content-card-modern { padding: 1.5rem; } .dashboard-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); } .dashboard-card h3 { color: var(--color-brand-text-secondary); }
        .profile-card { background-color: var(--color-brand-white); border-radius: var(--border-radius-large); box-shadow: var(--shadow-soft); padding: 1.5rem; } .profile-card h3 { font-size: 1.125rem; font-weight: 600; color: var(--color-brand-primary); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-brand-border-light); } .profile-card p, .profile-card li { font-size: 0.875rem; color: var(--color-brand-text-secondary); margin-bottom: 0.375rem; } .profile-card strong { color: var(--color-brand-text-primary); } .profile-card ul { list-style: none; padding: 0; } .profile-card li { padding: 0.625rem 0; border-bottom: 1px dashed var(--color-brand-border-light); } .profile-card li:last-child { border-bottom: none; } .profile-card .sub-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-brand-light-bg); } .profile-card .sub-section h4 { font-size: 0.875rem; font-weight: 600; color: var(--color-brand-primary); margin-bottom: 0.5rem; }
        #detallePerfilClientePreview.profile-detail-card { background-color: var(--color-brand-light-bg); border-radius: var(--border-radius-medium); box-shadow: var(--shadow-soft); max-height: 70vh; overflow-y: auto; }
        .btn { transition: all 0.2s ease-in-out; border-radius: var(--border-radius-medium); } .btn:hover { transform: translateY(-1px); filter: brightness(1.05); } .btn:active { transform: translateY(0px); filter: brightness(0.95); }
        .btn-primary-modern { background-color: var(--color-brand-primary); color: var(--color-brand-white); font-weight: 500; padding: 0.625rem 1.25rem; border-radius: var(--border-radius-medium); box-shadow: var(--shadow-soft); } .btn-primary-modern:hover { background-color: var(--color-brand-primary-hover); box-shadow: var(--shadow-medium); } .btn-primary-modern:active { background-color: var(--color-brand-primary-active); } .btn-primary-modern svg { fill: currentColor; stroke: currentColor; }
        .btn-secondary-modern { background-color: var(--color-brand-light-bg); color: var(--color-brand-primary); font-weight: 500; padding: 0.625rem 1.25rem; border-radius: var(--border-radius-medium); border: 1px solid var(--color-brand-border-light); box-shadow: var(--shadow-soft); } .btn-secondary-modern:hover { background-color: var(--color-brand-border-light); border-color: var(--color-brand-border-focus); color: var(--color-brand-primary-hover); } .btn-secondary-modern svg { stroke: currentColor; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"], input[type="password"], textarea, select { border-radius: var(--border-radius-medium) !important; border: 1px solid var(--color-brand-border-light) !important; padding: 0.625rem 0.875rem !important; color: var(--color-brand-text-primary) !important; background-color: var(--color-brand-white) !important; box-shadow: 0 1px 2px rgba(0,0,0,0.03) !important; transition: border-color 0.2s ease, box-shadow 0.2s ease; } input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="password"]:focus, textarea:focus, select:focus { border-color: var(--color-brand-border-focus) !important; box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-brand-primary) 20%, transparent) !important; outline: none !important; } label { color: var(--color-brand-text-secondary); font-weight: 500; }
        .modal { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; z-index: 50; } .modal.active { display: flex; opacity: 1; } .modal-content { background-color: var(--color-brand-white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-strong); border: none; transition: transform 0.3s ease-in-out; transform: translateY(-20px); } .modal.active .modal-content { transform: translateY(0); } .modal-content h3.text-2xl { color: var(--color-brand-primary); } .modal-content .service-group { border-top: 1px solid var(--color-brand-border-light); margin-top: 1.5rem; padding-top: 1.5rem; } .modal-content .service-group h4 { color: var(--color-brand-primary); font-weight: 600; }
        .table-container-modern { background-color: var(--color-brand-white); border-radius: var(--border-radius-large); box-shadow: var(--shadow-soft); overflow: hidden; } .table-container-modern table thead { background-color: var(--color-brand-light-bg); } .table-container-modern table th { color: var(--color-brand-text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--color-brand-border-light); padding: 0.75rem 1.5rem; } .table-container-modern table td { color: var(--color-brand-text-primary); border-bottom: 1px solid var(--color-brand-light-bg); padding: 0.75rem 1.5rem; } .table-container-modern table tr:last-child td { border-bottom: none; } .table-container-modern table tr:hover td { background-color: var(--color-brand-bg-main-start); }
        .table-container-modern .ver-perfil-btn, .table-container-modern .editar-cliente-btn, .table-container-modern .editar-tarea-btn, .table-container-modern .editar-publicacion-btn { color: var(--color-brand-primary); } .table-container-modern .ver-perfil-btn:hover, .table-container-modern .editar-cliente-btn:hover, .table-container-modern .editar-tarea-btn:hover, .table-container-modern .editar-publicacion-btn:hover { color: var(--color-brand-primary-hover); text-decoration: underline; } .table-container-modern .eliminar-cliente-btn, .table-container-modern .eliminar-tarea-btn, .table-container-modern .eliminar-publicacion-btn, .table-container-modern .eliminar-ingreso-btn, .table-container-modern .eliminar-cuentacobrar-btn, .table-container-modern .eliminar-cuentaempresa-btn { color: var(--tw-colors-danger, #EF4444); } .table-container-modern .eliminar-cliente-btn:hover, .table-container-modern .eliminar-tarea-btn:hover, .table-container-modern .eliminar-publicacion-btn:hover, .table-container-modern .eliminar-ingreso-btn:hover, .table-container-modern .eliminar-cuentacobrar-btn:hover, .table-container-modern .eliminar-cuentaempresa-btn:hover { color: var(--tw-colors-red-700, #b91c1c); text-decoration: underline; }
        .page-section.hidden { display: none !important; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: color-mix(in srgb, var(--color-brand-sidebar) 80%, black); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white; font-size: 1.2em; } .spinner, .spinner-inline { border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; } .spinner { width: 40px; height: 40px; margin-bottom: 10px; } .spinner-inline { display: inline-block; width: 1em; height: 1em; vertical-align: -0.125em; margin-right: 0.5rem;} @keyframes spinner-border { to { transform: rotate(360deg); } }
        p { line-height: 1.6; }
        ::-webkit-scrollbar { width: 10px; height: 10px; } ::-webkit-scrollbar-track { background: var(--color-brand-bg-main-start); border-radius: 10px;} ::-webkit-scrollbar-thumb { background: var(--color-brand-border-focus); border-radius: 10px; border: 2px solid var(--color-brand-bg-main-start); } ::-webkit-scrollbar-thumb:hover { background: var(--color-brand-primary); }
        .vanilla-calendar { box-shadow: var(--shadow-soft); border: 1px solid var(--color-brand-border-light); border-radius: var(--border-radius-large); margin-bottom: 1.5rem; background-color: var(--color-brand-white); } .vanilla-calendar .vanilla-calendar-header { background-color: var(--color-brand-light-bg); padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-brand-border-light); } .vanilla-calendar .vanilla-calendar-header *, .vanilla-calendar .vanilla-calendar-week__day { color: var(--color-brand-text-primary); } .vanilla-calendar .vanilla-calendar-week__day { font-weight: 600; } .vanilla-calendar .vanilla-calendar-day__btn_today:not(.vanilla-calendar-day__btn_selected) { background-color: color-mix(in srgb, var(--color-brand-primary) 20%, transparent) !important; color: var(--color-brand-primary) !important; border-radius: 50%; } .vanilla-calendar .vanilla-calendar-day__btn_selected { background-color: var(--color-brand-primary) !important; color: var(--color-brand-white) !important; border-radius: 50%; box-shadow: 0 0 0 2px var(--color-brand-white), 0 0 0 4px var(--color-brand-primary); } .vanilla-calendar .vanilla-calendar-day__btn:hover:not(.vanilla-calendar-day__btn_selected):not(.vanilla-calendar-day__btn_disabled) { background-color: var(--color-brand-border-light) !important; border-radius: 50%; } .vanilla-calendar .vanilla-calendar-day__marker { background-color: var(--color-brand-primary); width: 6px; height: 6px; border-radius: 50%; margin-top: 3px; display: block; }
        html.dark .vanilla-calendar .vanilla-calendar-day__btn_selected { color: #111827 !important; }
        html.dark .vanilla-calendar .vanilla-calendar-day__btn_today:not(.vanilla-calendar-day__btn_selected) { background-color: color-mix(in srgb, var(--color-brand-primary) 40%, transparent) !important; }
    </style>
</head>
<body class="font-sans">

<div id="loginScreen" class="fixed inset-0 bg-brand-sidebar flex items-center justify-center z-[10001]">
    <div class="bg-brand-white dark:bg-slate-800 p-8 rounded-xl shadow-xl w-full max-w-sm text-center">
        <img src="images/logo-color.png" alt="Medi Clicks Logo" class="h-auto w-3/4 max-w-[200px] mx-auto mb-6">
        <h2 class="text-2xl font-semibold text-brand-primary dark:text-primary-light mb-6">Iniciar Sesión</h2>
        <form id="loginForm">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-brand-text-secondary dark:text-slate-400 text-left mb-1">Usuario</label>
                <input type="text" id="username" name="username" required class="w-full dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200 dark:focus:border-primary-light dark:focus:ring-primary-light/30">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-brand-text-secondary dark:text-slate-400 text-left mb-1">Contraseña</label>
                <input type="password" id="password" name="password" required class="w-full dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200 dark:focus:border-primary-light dark:focus:ring-primary-light/30">
            </div>
            <button type="submit" class="w-full btn btn-primary-modern">Ingresar</button>
        </form>
        <p id="loginError" class="text-danger text-sm mt-4 hidden"></p>
    </div>
</div>

<div id="loadingOverlay" style="display: none;">
    <img src="images/logo-completo-blanco.png" alt="Cargando Medi Clicks" class="h-auto w-1/2 max-w-[200px] mb-4">
    <div class="spinner"></div>
    <span id="loadingMessage">Cargando datos iniciales...</span>
</div>

    <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-[60] p-2 bg-brand-primary text-white rounded-md shadow-lg" style="display: none;">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <div class="content-wrapper">
        <aside class="w-64 flex flex-col transform -translate-x-full lg:translate-x-0 fixed lg:sticky top-0 h-screen">
            <div class="p-4 border-b flex flex-col items-center sidebar-logo-container">
                <img src="images/logo-completo-blanco.png" alt="Medi Clicks Logo" class="h-auto w-3/4 max-w-[180px] mb-3">
                <p class="text-sm text-center opacity-80">Panel de Gestión</p>
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-2 btn">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </a>
                <a href="#clientes" class="nav-link flex items-center px-4 py-2 btn">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Clientes
                </a>
                <a href="#tareas" class="nav-link flex items-center px-4 py-2 btn">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Tareas
                </a>
                <a href="#publicaciones" class="nav-link flex items-center px-4 py-2 btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Publicaciones
                </a>
                <a href="#paquetes-servicios" class="nav-link flex items-center px-4 py-2 btn">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Paquetes Servicios
                </a>
                <a href="#servicios-web" class="nav-link flex items-center px-4 py-2 btn">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    Servicios Web
                </a>
                <a href="#administracion" class="nav-link flex items-center px-4 py-2 btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    Administración
                </a>
            </nav>
            <div class="p-4 mt-auto border-t border-[rgba(255,255,255,0.1)]">
                <button id="theme-toggle" class="w-full flex items-center justify-center px-4 py-2 text-sm nav-link mb-2">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 mr-2 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 mr-2 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414-1.414l-.707-.707a1 1 0 01-1.414 1.414l.707.707zm1.414-3.536a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100 2h1a1 1 0 100-2H3z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    <span id="theme-toggle-text"></span>
                </button>
                 <button id="btnLogout" class="w-full flex items-center justify-center px-4 py-2 text-sm nav-link bg-red-500/20 hover:bg-red-600/30 text-red-100 dark:bg-red-700/30 dark:hover:bg-red-600/40 dark:text-red-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Cerrar Sesión
                </button>
            </div>
        </aside>

        <main class="flex-grow p-6 md:p-8 lg:ml-64"> 
            <!-- El contenido de las secciones se pega aquí -->
            <section id="dashboard" class="page-section mb-8">
                <h2 class="text-2xl font-semibold mb-6">Dashboard General</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="dashboard-card p-6 border-l-4 border-success">
                        <h3 class="text-lg font-semibold mb-2">Clientes Activos</h3>
                        <p id="totalClientesActivos" class="text-4xl font-bold text-success">0</p>
                        <p class="text-sm text-brand-text-secondary mt-1">Total clientes registrados.</p>
                    </div>
                    <div class="dashboard-card p-6 border-l-4 border-danger">
                        <h3 class="text-lg font-semibold mb-2">Tareas Pendientes</h3>
                        <p id="totalTareasPendientes" class="text-4xl font-bold text-danger">0</p>
                        <p class="text-sm text-brand-text-secondary mt-1">Tareas por completar.</p>
                    </div>
                    <div class="dashboard-card p-6 border-l-4 border-warning">
                        <h3 class="text-lg font-semibold mb-2">Servicios por Vencer</h3>
                        <p id="totalClientesRevisar" class="text-4xl font-bold text-warning">0</p>
                        <p class="text-sm text-brand-text-secondary mt-1">Vencen en próximos 30 días.</p>
                    </div>
                    <div class="dashboard-card p-6 border-l-4 border-info">
                        <h3 class="text-lg font-semibold mb-2">Servicios Web</h3>
                        <p id="totalServiciosWeb" class="text-4xl font-bold text-info">0</p>
                        <p class="text-sm text-brand-text-secondary mt-1">Total dominios/proyectos.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="content-card-modern h-fit">
                            <h3 class="text-xl font-semibold mb-4">Perfiles de Clientes (Acceso Rápido)</h3>
                            <div id="listaPerfilesClientes" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            </div>
                            <div id="detallePerfilClientePreview" class="profile-detail-card p-6 hidden">
                            </div>
                        </div>

                        <div class="content-card-modern">
                            <h3 class="text-xl font-semibold mb-4 text-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Tareas Urgentes
                            </h3>
                            <ul id="listaTareasUrgentesDashboard" class="space-y-2">
                                <li class="text-brand-text-secondary italic">No hay tareas urgentes.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        <div class="content-card-modern p-4 dashboard-calendar-card">
                            <h3 class="text-xl font-semibold text-center mb-4">Calendario de Tareas</h3>
                            <div id="calendar-container" class="mb-4"></div>
                            <button id="btnVerCalendarioCompleto" class="w-full btn btn-secondary-modern">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mb-px" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Ver Calendario Completo
                            </button>
                            <div class="mt-4 pt-4 border-t border-brand-border-light">
                                <h4 class="text-sm font-semibold text-brand-text-primary mb-2">Próximas Entregas:</h4>
                                <ul id="listaProximasTareasDashboard" class="space-y-1 text-xs">
                                    <li class="text-brand-text-secondary italic">No hay tareas próximas.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="content-card-modern">
                             <h3 class="text-xl font-semibold mb-4 text-warning">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Servicios Web por Vencer
                            </h3>
                            <p class="text-sm text-brand-text-secondary mb-3">Clientes con servicios web (dominio/mantenimiento) venciendo en los próximos 30 días.</p>
                            <ul id="listaServiciosPorVencerDashboard" class="space-y-2">
                                <li class="text-brand-text-secondary italic">No hay servicios web próximos a vencer.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="clientes" class="page-section mb-8 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Gestión General de Clientes</h2>
                    <div class="flex flex-wrap space-x-0 sm:space-x-3 gap-3 sm:gap-0">
                        <button id="btnAbrirModalCliente" class="btn btn-primary-modern flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Añadir Cliente
                        </button>
                        <button id="btnExportarCSVClientes" class="btn btn-secondary-modern flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Exportar Clientes (CSV)
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <input type="text" id="buscadorClientes" placeholder="Buscar cliente por nombre..." class="mt-1 block w-full md:w-1/2 lg:w-1/3">
                </div>
                <div class="table-container-modern overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Clínica</th>
                                <th>Servicios Principales</th>
                                <th>Pagado ($)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaClientesBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="perfil-cliente-dedicado" class="page-section mb-8 hidden">
                 <div class="flex justify-between items-center mb-6">
                       <h2 class="text-3xl font-bold" id="nombrePerfilDedicado">Perfil del Cliente</h2>
                       <div>
                           <button id="btnVolverDesdePerfil" class="btn btn-secondary-modern mr-2">Volver</button>
                           <button id="btnEditarDesdePerfil" class="btn btn-primary-modern">Editar Cliente</button>
                       </div>
                 </div>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                       <div class="lg:col-span-1 space-y-6">
                           <div class="profile-card">
                               <h3>Información General</h3>
                               <p><strong>Clínica:</strong> <span id="perfilDedicadoClinica">-</span></p>
                               <p><strong>Email:</strong> <span id="perfilDedicadoEmail">-</span></p>
                               <p><strong>Teléfono:</strong> <span id="perfilDedicadoTelefono">-</span></p>
                               <p><strong>Total Pagado:</strong> <span id="perfilDedicadoPagado">-</span></p>
                           </div>
                           <div class="profile-card">
                               <h3>Notas Generales</h3>
                               <p id="perfilDedicadoNotas" class="whitespace-pre-wrap">-</p>
                           </div>
                       </div>
                       <div class="lg:col-span-1 space-y-6">
                           <div class="profile-card">
                               <h3>Paquetes Contratados</h3>
                               <ul id="perfilDedicadoServiciosContratados">
                                   <li>No hay paquetes contratados.</li>
                               </ul>
                           </div>
                            <div class="profile-card">
                               <h3>Servicio Web</h3>
                               <p><strong>Dominio:</strong> <span id="perfilDedicadoDominioWeb">-</span></p>
                               <p><strong>Tipo:</strong> <span id="perfilDedicadoTipoWeb">-</span></p>
                               <p><strong>Vencimiento:</strong> <span id="perfilDedicadoVencimientoWeb">-</span></p>
                           </div>
                       </div>
                       <div class="lg:col-span-1 space-y-6">
                            <div class="profile-card">
                               <h3>Configuración Redes Sociales (General)</h3>
                               <div id="perfilDedicadoConfigRedes">
                                   <p class="text-xs text-brand-text-secondary">No hay configuración específica.</p>
                               </div>
                           </div>
                           <div class="profile-card">
                               <h3>Tareas Asociadas</h3>
                               <ul id="perfilDedicadoTareas">
                                   <li>No hay tareas asociadas.</li>
                               </ul>
                           </div>
                       </div>
                 </div>
            </section>

            <section id="tareas" class="page-section mb-8 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Gestión de Tareas</h2>
                    <button id="btnAbrirModalTarea" class="btn btn-primary-modern flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Añadir Tarea
                    </button>
                </div>
                <div class="table-container-modern overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Tarea</th>
                                <th>Cliente Asociado</th>
                                <th>Fecha Entrega</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTareasBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="publicaciones" class="page-section mb-8 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Gestión de Publicaciones</h2>
                    <button id="btnAbrirModalPublicacion" class="btn btn-primary-modern flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Añadir Publicación
                    </button>
                </div>
                <div class="mb-6 flex flex-wrap gap-4">
                    <div>
                        <label for="filtroPublicacionesCliente" class="block text-sm font-medium mb-1">Filtrar por Cliente:</label>
                        <select id="filtroPublicacionesCliente" class="mt-1 block w-full md:w-auto">
                            <option value="">Todos los Clientes</option>
                        </select>
                    </div>
                    <div>
                        <label for="filtroPublicacionesEstado" class="block text-sm font-medium mb-1">Filtrar por Estado:</label>
                        <select id="filtroPublicacionesEstado" class="mt-1 block w-full md:w-auto">
                            <option value="">Todos los Estados</option>
                            <option value="Borrador">Borrador</option>
                            <option value="Programada">Programada</option>
                            <option value="Revisión Cliente">Revisión Cliente</option>
                            <option value="Aprobada">Aprobada</option>
                            <option value="Publicada">Publicada</option>
                            <option value="Rechazada">Rechazada</option>
                        </select>
                    </div>
                </div>

                <div class="table-container-modern overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Red Social</th>
                                <th>Contenido (Extracto)</th>
                                <th>Fecha Pub.</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPublicacionesBody">
                        </tbody>
                    </table>
                </div>
                <div id="paginacionPublicacionesContainer" class="mt-6 flex justify-between items-center" style="display: none;">
                    <button id="btnPrevPublicaciones" class="btn btn-secondary-modern btn-sm" disabled>&laquo; Anterior</button>
                    <div id="numerosPaginaPublicaciones" class="text-sm text-brand-text-secondary">
                    </div>
                    <button id="btnNextPublicaciones" class="btn btn-secondary-modern btn-sm" disabled>Siguiente &raquo;</button>
                </div>
            </section>

            <section id="paquetes-servicios" class="page-section mb-8 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Gestión de Paquetes de Servicios</h2>
                    <button id="btnAbrirModalPaqueteServicio" class="btn btn-primary-modern flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Añadir Paquete
                    </button>
                </div>
                <div id="listaPaquetesServicios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </section>

            <section id="servicios-web" class="page-section mb-8 hidden">
                <h2 class="text-2xl font-semibold mb-4">Clientes con Servicios Web</h2>
                <div class="table-container-modern overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Dominio</th>
                                <th>Tipo Servicio</th>
                                <th>Vencimiento Mant./Dominio</th>
                            </tr>
                        </thead>
                        <tbody id="tablaServiciosWebBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="administracion" class="page-section mb-8 hidden">
                <h2 class="text-3xl font-bold mb-8">Administración General</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="content-card-modern md:col-span-2">
                        <div class="flex flex-wrap justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-brand-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Pagos e Ingresos
                            </h3>
                            <button id="btnAbrirModalIngreso" class="btn btn-primary-modern btn-sm flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Registrar Ingreso
                            </button>
                        </div>
                        <p class="text-brand-text-secondary mb-4">Registro y seguimiento de todos los ingresos de la empresa.</p>
                        <div class="mb-4 flex flex-wrap gap-4">
                            <div><label for="filtroIngresosCliente" class="block text-xs font-medium mb-1">Cliente:</label><select id="filtroIngresosCliente" class="mt-1 block w-full md:w-auto text-sm"><option value="">Todos</option></select></div>
                            <div><label for="filtroIngresosMes" class="block text-xs font-medium mb-1">Mes:</label><input type="month" id="filtroIngresosMes" class="mt-1 block w-full md:w-auto text-sm"></div>
                        </div>
                        <div class="table-container-modern overflow-x-auto max-h-96">
                            <table class="min-w-full">
                                <thead><tr><th>Fecha Pago</th><th>Cliente</th><th>Concepto</th><th>Monto</th><th>Método</th><th>Acciones</th></tr></thead>
                                <tbody id="tablaIngresosBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right"><p class="text-lg font-semibold">Total Visualizado: <span id="totalIngresosVisualizados" class="text-success">$0.00</span></p></div>
                    </div>
                    <div class="content-card-modern md:col-span-2">
                        <div class="flex flex-wrap justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-brand-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                Cuentas por Cobrar
                            </h3>
                            <button id="btnAbrirModalCuentaCobrar" class="btn btn-primary-modern btn-sm flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Añadir Cuenta
                            </button>
                        </div>
                        <p class="text-brand-text-secondary mb-4">Gestión de facturas pendientes y seguimiento de cobros a clientes.</p>
                         <div class="mb-4 flex flex-wrap gap-4">
                            <div><label for="filtroCuentasCobrarCliente" class="block text-xs font-medium mb-1">Cliente:</label><select id="filtroCuentasCobrarCliente" class="mt-1 block w-full md:w-auto text-sm"><option value="">Todos</option></select></div>
                            <div><label for="filtroCuentasCobrarEstado" class="block text-xs font-medium mb-1">Estado:</label><select id="filtroCuentasCobrarEstado" class="mt-1 block w-full md:w-auto text-sm"><option value="">Todos</option><option value="Pendiente">Pendiente</option><option value="Pagada Parcialmente">Pagada Parcialmente</option><option value="Pagada">Pagada</option><option value="Vencida">Vencida</option><option value="Cancelada">Cancelada</option></select></div>
                        </div>
                        <div class="table-container-modern overflow-x-auto max-h-96">
                             <table class="min-w-full">
                                <thead><tr><th>Cliente</th><th>Concepto</th><th>Monto Total</th><th>Monto Pagado</th><th>Saldo</th><th>F. Emisión</th><th>F. Vencim.</th><th>Estado</th><th>Acciones</th></tr></thead>
                                <tbody id="tablaCuentasCobrarBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right"><p class="text-lg font-semibold">Saldo Pendiente Visualizado: <span id="totalSaldoPendienteVisualizado" class="text-danger">$0.00</span></p></div>
                    </div>
                    <div class="content-card-modern md:col-span-2">
                        <div class="flex flex-wrap justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-brand-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11V9c0-1.044.204-2.035.568-2.951M16 11c0 3.517.99 6.799 2.752 9.571m3.44-2.04l-.054-.09A13.916 13.916 0 0116 11V9c0-1.044-.204-2.035-.568-2.951" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Cuentas de la Empresa
                            </h3>
                             <button id="btnAbrirModalCuentaEmpresa" class="btn btn-primary-modern btn-sm flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Añadir Cuenta
                            </button>
                        </div>
                        <p class="text-brand-text-secondary mb-1">Información bancaria, plataformas de pago y otros datos financieros.</p>
                        <p class="text-xs text-danger mb-4"><strong>Advertencia:</strong> Esta información es sensible. Asegura la privacidad de tu Hoja de Cálculo.</p>
                        <div class="table-container-modern overflow-x-auto max-h-72">
                             <table class="min-w-full">
                                <thead><tr><th>Entidad</th><th>Tipo</th><th>Identificador</th><th>Titular</th><th>Moneda</th><th>Acciones</th></tr></thead>
                                <tbody id="tablaCuentasEmpresaBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="content-card-modern"> 
                        <h3 class="text-xl font-semibold text-brand-primary mb-4">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Facturación Electrónica
                        </h3>
                        <p class="text-brand-text-secondary">Integración con sistema de facturación electrónica (futura implementación).</p>
                         <div class="mt-4">
                            <button class="btn btn-primary-modern opacity-50 cursor-not-allowed">Integrar Facturación (Próximamente)</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modales -->
    <!-- ... (Todos tus modales van aquí, sin cambios respecto al código anterior) ... -->
    <div id="modalCliente" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-2xl mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalClienteTitle" class="text-2xl font-semibold">Añadir Nuevo Cliente</h3>
                <button id="btnCerrarModalCliente" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button>
            </div>
            <form id="formCliente">
                <h4 class="text-lg font-semibold mb-3">Información General</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                    <div><label for="nombreCliente" class="block text-sm font-medium mb-1">Nombre Completo<span class="text-danger">*</span></label><input type="text" id="nombreCliente" required></div>
                    <div><label for="clinicaCliente" class="block text-sm font-medium mb-1">Clínica/Consultorio</label><input type="text" id="clinicaCliente"></div>
                    <div><label for="emailCliente" class="block text-sm font-medium mb-1">Email</label><input type="email" id="emailCliente"></div>
                    <div><label for="telefonoCliente" class="block text-sm font-medium mb-1">Teléfono</label><input type="tel" id="telefonoCliente"></div>
                </div>
                <div class="mb-4"><label for="serviciosActivosGeneralCliente" class="block text-sm font-medium mb-1">Servicios Activos (Resumen)</label><input type="text" id="serviciosActivosGeneralCliente" placeholder="Ej: Web, Redes, SEO"></div>
                <div class="mb-4"><label for="pagadoCliente" class="block text-sm font-medium mb-1">Total Pagado ($)</label><input type="number" id="pagadoCliente" step="0.01" value="0"></div>
                <div class="mb-6"><label for="notasCliente" class="block text-sm font-medium mb-1">Registro/Detalles Generales</label><textarea id="notasCliente" rows="3"></textarea></div>
                <div class="service-group"><h4 class="text-lg font-semibold mb-3 mt-2">Detalles Servicio Web</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"><div><label for="dominioWebCliente">Dominio Web</label><input type="text" id="dominioWebCliente" placeholder="ej: cliente.com"></div><div><label for="tipoServicioWebCliente">Tipo Servicio Web</label><input type="text" id="tipoServicioWebCliente" placeholder="Ej: Desarrollo, Mantenimiento"></div></div><div class="mb-4"><label for="vencimientoWebCliente">Vencimiento Mant./Dominio</label><input type="date" id="vencimientoWebCliente"></div></div>
                <div class="service-group"><h4 class="text-lg font-semibold mb-3 mt-2">Detalles Redes Sociales (General)</h4><div class="mb-4"><label for="plataformasRedesCliente">Plataformas (separadas por coma)</label><input type="text" id="plataformasRedesCliente" placeholder="Ej: Instagram, Facebook, X"></div><div class="mb-4"><label for="detallesRedesCliente">Estrategia/Detalles Redes</label><textarea id="detallesRedesCliente" rows="3"></textarea></div></div>
                <div class="service-group"><h4 class="text-lg font-semibold mb-3 mt-2">Paquetes de Servicios Contratados</h4><div id="serviciosContratadosContainer" class="space-y-4 mb-4"></div><div class="flex items-center gap-x-4"><select id="selectPaqueteServicio" class="block w-full"><option value="">Seleccionar paquete...</option></select><input type="number" id="montoPaqueteServicio" placeholder="Monto" step="0.01" class="block w-1/3"><select id="tipoCobroPaqueteServicio" class="block w-1/3"><option value="mensual">Mensual</option><option value="anual">Anual</option></select><button type="button" id="btnAddServicioContratado" class="btn btn-secondary-modern text-sm">Añadir</button></div></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalCliente" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Cliente</button></div>
            </form>
        </div>
    </div>
    <div id="modalTarea" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-lg mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalTareaTitle" class="text-2xl font-semibold">Añadir Nueva Tarea</h3><button id="btnCerrarModalTarea" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formTarea">
                <div class="mb-4"><label for="nombreTarea" class="block text-sm font-medium mb-1">Nombre de la Tarea<span class="text-danger">*</span></label><input type="text" id="nombreTarea" required></div>
                <div class="mb-4"><label for="clienteAsociadoTarea" class="block text-sm font-medium mb-1">Cliente Asociado</label><select id="clienteAsociadoTarea"><option value="">Ninguno</option></select></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4"><div><label for="fechaEntregaTarea">Fecha de Entrega</label><input type="date" id="fechaEntregaTarea"></div><div><label for="estadoTarea">Estado</label><select id="estadoTarea"><option value="Pendiente">Pendiente</option><option value="En Progreso">En Progreso</option><option value="Completada">Completada</option></select></div></div>
                <div class="mb-6"><label for="descripcionTarea">Descripción (Opcional)</label><textarea id="descripcionTarea" rows="3"></textarea></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalTarea" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Tarea</button></div>
            </form>
        </div>
    </div>
    <div id="modalPublicacion" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-2xl mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalPublicacionTitle" class="text-2xl font-semibold">Añadir Nueva Publicación</h3><button id="btnCerrarModalPublicacion" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formPublicacion">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                    <div><label for="clientePublicacion">Cliente<span class="text-danger">*</span></label><select id="clientePublicacion" required><option value="">-- Seleccione Cliente --</option></select></div>
                    <div><label for="redSocialPublicacion">Red Social<span class="text-danger">*</span></label><select id="redSocialPublicacion" required><option value="">-- Seleccione Red --</option><option value="Instagram">Instagram</option><option value="Facebook">Facebook</option><option value="X">X (Twitter)</option><option value="LinkedIn">LinkedIn</option><option value="TikTok">TikTok</option><option value="Blog">Blog</option><option value="Otra">Otra</option></select></div>
                    <div><label for="fechaPublicacion">Fecha Publicación<span class="text-danger">*</span></label><input type="date" id="fechaPublicacion" required></div>
                    <div><label for="horaPublicacion">Hora Publicación</label><input type="time" id="horaPublicacion"></div>
                    <div><label for="tipoContenidoPublicacion">Tipo de Contenido</label><input type="text" id="tipoContenidoPublicacion" placeholder="Ej: Post, Reel, Story"></div>
                    <div><label for="estadoPublicacion">Estado<span class="text-danger">*</span></label><select id="estadoPublicacion" required><option value="Borrador">Borrador</option><option value="Programada">Programada</option><option value="Revisión Cliente">Revisión Cliente</option><option value="Aprobada">Aprobada</option><option value="Publicada">Publicada</option><option value="Rechazada">Rechazada</option></select></div>
                </div>
                <div class="mb-4"><label for="contenidoTextoPublicacion">Contenido / Copy<span class="text-danger">*</span></label><textarea id="contenidoTextoPublicacion" rows="5" required placeholder="Escribe el contenido..."></textarea></div>
                <div class="mb-4"><label for="enlaceMediaPublicacion">Enlace a Media</label><input type="url" id="enlaceMediaPublicacion" placeholder="https://..."></div>
                <div class="mb-6"><label for="notasInternasPublicacion">Notas Internas</label><textarea id="notasInternasPublicacion" rows="3" placeholder="Comentarios..."></textarea></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalPublicacion" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Publicación</button></div>
            </form>
        </div>
    </div>
    <div id="modalPaqueteServicio" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-lg mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalPaqueteServicioTitle" class="text-2xl font-semibold">Añadir Nuevo Paquete</h3><button id="btnCerrarModalPaqueteServicio" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formPaqueteServicio">
                <div class="mb-4"><label for="nombrePaquete">Nombre del Paquete<span class="text-danger">*</span></label><input type="text" id="nombrePaquete" required></div>
                <div class="mb-4"><label for="categoriaPaquete">Categoría</label><input type="text" id="categoriaPaquete" placeholder="Ej: Redes Sociales, SEO"></div>
                <div class="mb-4"><label for="descripcionPaquete">Descripción</label><textarea id="descripcionPaquete" rows="4" class="mt-1 block w-full"></textarea></div>
                <div class="mb-4"><label for="precioSugeridoPaquete">Precio Sugerido (Opcional)</label><input type="number" id="precioSugeridoPaquete" step="0.01" placeholder="0.00"></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalPaqueteServicio" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Paquete</button></div>
            </form>
        </div>
    </div>
    <div id="modalIngreso" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-lg mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalIngresoTitle" class="text-2xl font-semibold">Registrar Nuevo Ingreso</h3><button id="btnCerrarModalIngreso" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formIngreso">
                <div class="mb-4"><label for="clienteIngreso">Cliente<span class="text-danger">*</span></label><select id="clienteIngreso" required><option value="">-- Seleccione Cliente --</option></select></div>
                <div class="mb-4"><label for="fechaPagoIngreso">Fecha de Pago<span class="text-danger">*</span></label><input type="date" id="fechaPagoIngreso" required></div>
                <div class="mb-4"><label for="montoIngreso">Monto<span class="text-danger">*</span></label><input type="number" id="montoIngreso" step="0.01" required placeholder="0.00"></div>
                <div class="mb-4"><label for="conceptoIngreso">Concepto<span class="text-danger">*</span></label><input type="text" id="conceptoIngreso" required placeholder="Ej: Paquete Redes Enero"></div>
                <div class="mb-4"><label for="metodoPagoIngreso">Método de Pago</label><select id="metodoPagoIngreso"><option value="">-- Método --</option><option value="Transferencia">Transferencia</option><option value="Efectivo">Efectivo</option><option value="PayPal">PayPal</option><option value="Stripe">Stripe</option><option value="MercadoPago">MercadoPago</option><option value="Otro">Otro</option></select></div>
                <div class="mb-4"><label for="referenciaPaqueteIngreso">Paquete Asociado (Opcional)</label><select id="referenciaPaqueteIngreso"><option value="">-- Ninguno --</option></select></div>
                <div class="mb-6"><label for="notasIngreso">Notas Adicionales</label><textarea id="notasIngreso" rows="3"></textarea></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalIngreso" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Ingreso</button></div>
            </form>
        </div>
    </div>
    <div id="modalCuentaCobrar" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-xl mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalCuentaCobrarTitle" class="text-2xl font-semibold">Añadir Nueva Cuenta por Cobrar</h3><button id="btnCerrarModalCuentaCobrar" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formCuentaCobrar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                    <div><label for="clienteCuentaCobrar">Cliente<span class="text-danger">*</span></label><select id="clienteCuentaCobrar" required><option value="">-- Seleccione Cliente --</option></select></div>
                    <div><label for="conceptoCuentaCobrar">Concepto<span class="text-danger">*</span></label><input type="text" id="conceptoCuentaCobrar" required placeholder="Ej: Factura #123"></div>
                    <div><label for="montoCuentaCobrar">Monto Total<span class="text-danger">*</span></label><input type="number" id="montoCuentaCobrar" step="0.01" required placeholder="0.00"></div>
                    <div><label for="montoPagadoCuentaCobrar">Monto Pagado Inicialmente</label><input type="number" id="montoPagadoCuentaCobrar" step="0.01" placeholder="0.00" value="0"></div>
                    <div><label for="fechaEmisionCuentaCobrar">Fecha de Emisión<span class="text-danger">*</span></label><input type="date" id="fechaEmisionCuentaCobrar" required></div>
                    <div><label for="fechaVencimientoCuentaCobrar">Fecha de Vencimiento</label><input type="date" id="fechaVencimientoCuentaCobrar"></div>
                    <div><label for="estadoCuentaCobrar">Estado<span class="text-danger">*</span></label><select id="estadoCuentaCobrar" required><option value="Pendiente">Pendiente</option><option value="Pagada Parcialmente">Pagada Parcialmente</option><option value="Pagada">Pagada</option><option value="Vencida">Vencida</option><option value="Cancelada">Cancelada</option></select></div>
                    <div><label for="fechaUltimoPagoCuentaCobrar">Fecha Último Pago</label><input type="date" id="fechaUltimoPagoCuentaCobrar"></div>
                </div>
                <div class="mb-6"><label for="notasCuentaCobrar">Notas</label><textarea id="notasCuentaCobrar" rows="3"></textarea></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalCuentaCobrar" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Cuenta</button></div>
            </form>
        </div>
    </div>
    <div id="modalCuentaEmpresa" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black overflow-y-auto h-full w-full items-center justify-center z-50 p-4">
        <div class="modal-content w-full max-w-lg mx-auto max-h-[95vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-6"><h3 id="modalCuentaEmpresaTitle" class="text-2xl font-semibold">Añadir Cuenta de Empresa</h3><button id="btnCerrarModalCuentaEmpresa" class="text-brand-text-secondary hover:text-brand-primary text-4xl leading-none btn">&times;</button></div>
            <form id="formCuentaEmpresa">
                <div class="mb-4"><label for="nombreEntidadCuentaEmpresa">Nombre Entidad (Banco, Plataforma)<span class="text-danger">*</span></label><input type="text" id="nombreEntidadCuentaEmpresa" required></div>
                <div class="mb-4"><label for="tipoCuentaEmpresa">Tipo de Cuenta<span class="text-danger">*</span></label><input type="text" id="tipoCuentaEmpresa" placeholder="Ej: Corriente, PayPal, Caja Chica" required></div>
                <div class="mb-4"><label for="identificadorCuentaEmpresa">Identificador (Nº Cuenta, Email, etc.)<span class="text-danger">*</span></label><input type="text" id="identificadorCuentaEmpresa" required></div>
                <div class="mb-4"><label for="titularCuentaEmpresa">Titular</label><input type="text" id="titularCuentaEmpresa"></div>
                <div class="mb-4"><label for="monedaCuentaEmpresa">Moneda</label><input type="text" id="monedaCuentaEmpresa" placeholder="Ej: USD, EUR, MXN"></div>
                <div class="mb-6"><label for="notasConfidencialesCuentaEmpresa">Notas Confidenciales</label><textarea id="notasConfidencialesCuentaEmpresa" rows="3" placeholder="Información sensible, solo para tu referencia."></textarea></div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="btnCancelarModalCuentaEmpresa" class="btn btn-secondary-modern">Cancelar</button><button type="submit" class="btn btn-primary-modern">Guardar Cuenta</button></div>
            </form>
        </div>
    </div>
    <div id="modalConfirmacion" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-opacity-80 dark:bg-black items-center justify-center z-[60] p-4">
        <div class="modal-content w-full max-w-md mx-auto p-6 md:p-8 text-center">
            <h3 id="modalConfirmacionTitle" class="text-xl font-semibold text-brand-text-primary mb-3">Confirmar Acción</h3>
            <p id="modalConfirmacionMessage" class="text-brand-text-secondary mb-6">¿Estás seguro?</p>
            <div class="flex justify-center space-x-4"><button id="btnConfirmarModalAccion" class="btn btn-primary-modern bg-danger hover:bg-red-700">Confirmar</button><button id="btnCancelarModalConfirmacion" class="btn btn-secondary-modern">Cancelar</button></div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.6.1/build/vanilla-js-calendar.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Theme toggle elements
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
            const themeToggleTextEl = document.getElementById('theme-toggle-text'); 

            // Sidebar toggle elements
            const sidebarEl = document.querySelector('aside'); 
            const mainContentForSidebar = document.querySelector('main'); 
            const sidebarToggleBtnEl = document.getElementById('sidebar-toggle'); 


            const navLinks = document.querySelectorAll('nav .nav-link'); // CORREGIDO: Solo los .nav-link dentro del <nav>
            const pageSections = document.querySelectorAll('.page-section');
            const btnAbrirModalCliente = document.getElementById('btnAbrirModalCliente');
            const modalCliente = document.getElementById('modalCliente');
            const modalClienteContent = modalCliente.querySelector('.modal-content');
            const btnCerrarModalCliente = document.getElementById('btnCerrarModalCliente');
            const btnCancelarModalCliente = document.getElementById('btnCancelarModalCliente');
            const formCliente = document.getElementById('formCliente');
            const modalClienteTitle = document.getElementById('modalClienteTitle');
            const serviciosContratadosContainer = document.getElementById('serviciosContratadosContainer');
            const selectPaqueteServicio = document.getElementById('selectPaqueteServicio');
            const montoPaqueteServicioInput = document.getElementById('montoPaqueteServicio');
            const tipoCobroPaqueteServicioSelect = document.getElementById('tipoCobroPaqueteServicio');
            const btnAddServicioContratado = document.getElementById('btnAddServicioContratado');
            const btnAbrirModalTarea = document.getElementById('btnAbrirModalTarea');
            const modalTarea = document.getElementById('modalTarea');
            const modalTareaContent = modalTarea.querySelector('.modal-content');
            const btnCerrarModalTarea = document.getElementById('btnCerrarModalTarea');
            const btnCancelarModalTarea = document.getElementById('btnCancelarModalTarea');
            const formTarea = document.getElementById('formTarea');
            const modalTareaTitle = document.getElementById('modalTareaTitle');
            const clienteAsociadoTareaSelect = document.getElementById('clienteAsociadoTarea');
            const tablaClientesBody = document.getElementById('tablaClientesBody');
            const tablaServiciosWebBody = document.getElementById('tablaServiciosWebBody');
            const tablaTareasBody = document.getElementById('tablaTareasBody');
            const listaPaquetesServiciosEl = document.getElementById('listaPaquetesServicios');
            const totalClientesActivosEl = document.getElementById('totalClientesActivos');
            const totalClientesRevisarEl = document.getElementById('totalClientesRevisar');
            const totalServiciosWebEl = document.getElementById('totalServiciosWeb');
            const totalTareasPendientesEl = document.getElementById('totalTareasPendientes');
            const listaPerfilesClientesEl = document.getElementById('listaPerfilesClientes');
            const detallePerfilClientePreviewEl = document.getElementById('detallePerfilClientePreview');
            const perfilDedicadoSection = document.getElementById('perfil-cliente-dedicado');
            const nombrePerfilDedicadoEl = document.getElementById('nombrePerfilDedicado');
            const btnVolverDesdePerfil = document.getElementById('btnVolverDesdePerfil');
            const btnEditarDesdePerfil = document.getElementById('btnEditarDesdePerfil');
            const perfilDedicadoClinicaEl = document.getElementById('perfilDedicadoClinica');
            const perfilDedicadoEmailEl = document.getElementById('perfilDedicadoEmail');
            const perfilDedicadoTelefonoEl = document.getElementById('perfilDedicadoTelefono');
            const perfilDedicadoPagadoEl = document.getElementById('perfilDedicadoPagado');
            const perfilDedicadoNotasEl = document.getElementById('perfilDedicadoNotas');
            const perfilDedicadoServiciosContratadosUl = document.getElementById('perfilDedicadoServiciosContratados');
            const perfilDedicadoDominioWebEl = document.getElementById('perfilDedicadoDominioWeb');
            const perfilDedicadoTipoWebEl = document.getElementById('perfilDedicadoTipoWeb');
            const perfilDedicadoVencimientoWebEl = document.getElementById('perfilDedicadoVencimientoWeb');
            const perfilDedicadoConfigRedesDiv = document.getElementById('perfilDedicadoConfigRedes');
            const perfilDedicadoTareasUl = document.getElementById('perfilDedicadoTareas');
            const btnExportarCSVClientes = document.getElementById('btnExportarCSVClientes');
            const buscadorClientesInput = document.getElementById('buscadorClientes');
            const calendarContainer = document.getElementById('calendar-container');
            let calendarInstance = null;
            const listaTareasUrgentesDashboardEl = document.getElementById('listaTareasUrgentesDashboard');
            const listaServiciosPorVencerDashboardEl = document.getElementById('listaServiciosPorVencerDashboard');
            const tablaPublicacionesBody = document.getElementById('tablaPublicacionesBody');
            const btnAbrirModalPublicacion = document.getElementById('btnAbrirModalPublicacion');
            const modalPublicacion = document.getElementById('modalPublicacion');
            const modalPublicacionContent = modalPublicacion.querySelector('.modal-content');
            const btnCerrarModalPublicacion = document.getElementById('btnCerrarModalPublicacion');
            const btnCancelarModalPublicacion = document.getElementById('btnCancelarModalPublicacion');
            const formPublicacion = document.getElementById('formPublicacion');
            const modalPublicacionTitle = document.getElementById('modalPublicacionTitle');
            const clientePublicacionSelect = document.getElementById('clientePublicacion');
            const filtroPublicacionesClienteSelect = document.getElementById('filtroPublicacionesCliente');
            const filtroPublicacionesEstadoSelect = document.getElementById('filtroPublicacionesEstado');
            const btnAbrirModalPaqueteServicio = document.getElementById('btnAbrirModalPaqueteServicio');
            const modalPaqueteServicio = document.getElementById('modalPaqueteServicio');
            const modalPaqueteServicioContent = modalPaqueteServicio.querySelector('.modal-content');
            const btnCerrarModalPaqueteServicio = document.getElementById('btnCerrarModalPaqueteServicio');
            const btnCancelarModalPaqueteServicio = document.getElementById('btnCancelarModalPaqueteServicio');
            const formPaqueteServicio = document.getElementById('formPaqueteServicio');
            const modalConfirmacion = document.getElementById('modalConfirmacion');
            const modalConfirmacionContent = modalConfirmacion.querySelector('.modal-content');
            const modalConfirmacionTitleEl = document.getElementById('modalConfirmacionTitle');
            const modalConfirmacionMessageEl = document.getElementById('modalConfirmacionMessage');
            const btnConfirmarModalAccion = document.getElementById('btnConfirmarModalAccion');
            const btnCancelarModalConfirmacion = document.getElementById('btnCancelarModalConfirmacion');
            let confirmacionCallback = null;
            const btnVerCalendarioCompleto = document.getElementById('btnVerCalendarioCompleto');
            const listaProximasTareasDashboardEl = document.getElementById('listaProximasTareasDashboard');
            const tablaIngresosBody = document.getElementById('tablaIngresosBody');
            const btnAbrirModalIngreso = document.getElementById('btnAbrirModalIngreso');
            const modalIngreso = document.getElementById('modalIngreso');
            const modalIngresoContent = modalIngreso.querySelector('.modal-content');
            const btnCerrarModalIngreso = document.getElementById('btnCerrarModalIngreso');
            const btnCancelarModalIngreso = document.getElementById('btnCancelarModalIngreso');
            const formIngreso = document.getElementById('formIngreso');
            const clienteIngresoSelect = document.getElementById('clienteIngreso');
            const referenciaPaqueteIngresoSelect = document.getElementById('referenciaPaqueteIngreso');
            const filtroIngresosClienteSelect = document.getElementById('filtroIngresosCliente');
            const filtroIngresosMesInput = document.getElementById('filtroIngresosMes');
            const totalIngresosVisualizadosEl = document.getElementById('totalIngresosVisualizados');
            const tablaCuentasCobrarBody = document.getElementById('tablaCuentasCobrarBody');
            const btnAbrirModalCuentaCobrar = document.getElementById('btnAbrirModalCuentaCobrar');
            const modalCuentaCobrar = document.getElementById('modalCuentaCobrar');
            const modalCuentaCobrarContent = modalCuentaCobrar.querySelector('.modal-content');
            const btnCerrarModalCuentaCobrar = document.getElementById('btnCerrarModalCuentaCobrar');
            const btnCancelarModalCuentaCobrar = document.getElementById('btnCancelarModalCuentaCobrar');
            const formCuentaCobrar = document.getElementById('formCuentaCobrar');
            const clienteCuentaCobrarSelect = document.getElementById('clienteCuentaCobrar');
            const filtroCuentasCobrarClienteSelect = document.getElementById('filtroCuentasCobrarCliente');
            const filtroCuentasCobrarEstadoSelect = document.getElementById('filtroCuentasCobrarEstado');
            const totalSaldoPendienteVisualizadoEl = document.getElementById('totalSaldoPendienteVisualizado');
            const paginacionPublicacionesContainer = document.getElementById('paginacionPublicacionesContainer');
            const btnPrevPublicaciones = document.getElementById('btnPrevPublicaciones');
            const numerosPaginaPublicacionesEl = document.getElementById('numerosPaginaPublicaciones');
            const btnNextPublicaciones = document.getElementById('btnNextPublicaciones');
            const tablaCuentasEmpresaBody = document.getElementById('tablaCuentasEmpresaBody');
            const btnAbrirModalCuentaEmpresa = document.getElementById('btnAbrirModalCuentaEmpresa');
            const modalCuentaEmpresa = document.getElementById('modalCuentaEmpresa');
            const modalCuentaEmpresaContent = modalCuentaEmpresa.querySelector('.modal-content');
            const btnCerrarModalCuentaEmpresa = document.getElementById('btnCerrarModalCuentaEmpresa');
            const btnCancelarModalCuentaEmpresa = document.getElementById('btnCancelarModalCuentaEmpresa');
            const formCuentaEmpresa = document.getElementById('formCuentaEmpresa');

            const loginScreen = document.getElementById('loginScreen');
            const loginForm = document.getElementById('loginForm');
            const loginErrorEl = document.getElementById('loginError');
            const mainContentWrapper = document.querySelector('.content-wrapper'); 
            const btnLogout = document.getElementById('btnLogout');
            const SESSION_TOKEN_KEY = 'mediClicksSessionToken';


            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzP_meDnQRD5g_CPp6hI9m9Udzw6f9gwOMoscQiN6fetI_9NUOWTcmQUuo7ZuFrw6YP/exec";
            const GOOGLE_CALENDAR_ID_FOR_VIEW = "50ba71bc988d110add8e3ca4fea84000056fb4c8f49d02a5f4734d2cf261716f@group.calendar.google.com";

            function applyTheme(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    if(themeToggleDarkIcon) themeToggleDarkIcon.classList.remove('hidden');
                    if(themeToggleLightIcon) themeToggleLightIcon.classList.add('hidden');
                    if(themeToggleTextEl) themeToggleTextEl.textContent = 'Modo Claro';
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    if(themeToggleDarkIcon) themeToggleDarkIcon.classList.add('hidden');
                    if(themeToggleLightIcon) themeToggleLightIcon.classList.remove('hidden');
                    if(themeToggleTextEl) themeToggleTextEl.textContent = 'Modo Oscuro';
                    localStorage.setItem('theme', 'light');
                }
                if (calendarInstance) { 
                    if (typeof calendarInstance.setOptions === 'function') {
                         calendarInstance.setOptions({ settings: { visibility: { theme: isDark ? 'dark' : 'light' } } });
                         calendarInstance.update();
                    } else if (calendarInstance.destroy) { 
                        calendarInstance.destroy(); 
                        inicializarCalendario();
                    }
                }
            }

            let isDarkMode = localStorage.getItem('theme') === 'dark' ||
                             (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            applyTheme(isDarkMode);

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    isDarkMode = !isDarkMode;
                    applyTheme(isDarkMode);
                });
            } else {
                console.warn("Botón de cambio de tema (theme-toggle) no encontrado.");
            }

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!('theme' in localStorage)) { 
                    isDarkMode = e.matches;
                    applyTheme(isDarkMode);
                }
            });

            if (sidebarToggleBtnEl && sidebarEl) {
                sidebarToggleBtnEl.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    sidebarEl.classList.toggle('-translate-x-full');
                });
            } else {
                 console.warn("Botón de toggle de sidebar (sidebar-toggle) o el elemento sidebar no encontrados.");
            }

            document.addEventListener('click', function(event) {
                const isMobile = window.innerWidth < 1024; 
                if (isMobile && sidebarEl && !sidebarEl.classList.contains('-translate-x-full')) {
                    const isClickInsideSidebar = sidebarEl.contains(event.target);
                    const isClickOnToggleButton = sidebarToggleBtnEl ? sidebarToggleBtnEl.contains(event.target) : false;

                    if (!isClickInsideSidebar && !isClickOnToggleButton) {
                        sidebarEl.classList.add('-translate-x-full');
                    }
                }
            });


            function showToast(message, type = "info", duration = 3000) { let backgroundColor; switch (type) { case "success": backgroundColor = "linear-gradient(to right, #00b09b, #96c93d)"; break; case "error": backgroundColor = "linear-gradient(to right, #ff5f6d, #ffc371)"; break; case "warning": backgroundColor = "linear-gradient(to right, #f7971e, #ffd200)"; break; case "info": default: backgroundColor = "linear-gradient(to right, #2563EB, #60A5FA)"; break; } Toastify({ text: message, duration: duration, close: true, gravity: "top", position: "right", stopOnFocus: true, style: { background: backgroundColor, borderRadius: "var(--border-radius-medium)" } }).showToast(); }

            let clientes_data = []; let tareas_data = []; let publicaciones_data = []; let paquetes_servicios_data = []; let ingresos_data = []; let cuentas_cobrar_data = []; let cuentas_empresa_data = [];
            let editandoClienteIndex = null; let tempServiciosContratados = []; let editandoTareaIndex = null; let editandoPublicacionId = null; let editandoCuentaCobrarId = null; let editandoCuentaEmpresaId = null;
            let clienteSeleccionadoPerfilDedicadoId = null; let vistaAnterior = '#dashboard';
            let currentPagePublicaciones = 1; const itemsPerPagePublicaciones = 7;


            async function saveDataToSheets(action, payload) {
                showLoadingIndicator(true, "Procesando..."); // Cambiado el mensaje
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                if (!token && action !== 'loginUser' && action !== 'logoutUser') { 
                    showToast("Sesión no válida. Por favor, inicie sesión.", "error");
                    showLoginScreen(); 
                    showLoadingIndicator(false);
                    return { success: false, error: "No token" };
                }

                try {
                    const bodyPayload = { action: action, payload: payload };
                    if (action !== 'loginUser') { 
                        bodyPayload.sessionToken = token;
                    }

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        body: JSON.stringify(bodyPayload),
                        redirect: 'follow'
                    });
                    const result = await response.json();

                    if (result.status === "success") {
                        console.log(`${action} exitoso:`, result.message);
                        return { success: true, data: result.data || payload, message: result.message };
                    } else {
                        if (result.message && (result.message.toLowerCase().includes("unauthorized") || (result.details && result.details.toLowerCase().includes("unauthorized")))) {
                            showToast("Sesión expirada o no válida. Inicie sesión.", "error", 4000);
                            clearSessionAndShowLogin(); 
                        } else {
                            console.error(`Error ${action}:`, result.message, result.details);
                            showToast(`Error ${action}: ${result.message}`, "error", 5000);
                        }
                        return { success: false, error: result.message, details: result.details };
                    }
                } catch (error) {
                    console.error(`Fetch error ${action}:`, error);
                    showToast(`Error red ${action}.`, "error", 5000);
                    return { success: false, error: error.toString() };
                } finally {
                    showLoadingIndicator(false);
                }
            }


            async function fetchInitialData() {
                showLoadingIndicator(true, "Cargando datos iniciales...");
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                if (!token) {
                    showToast("Requiere inicio de sesión.", "info");
                    showLoadingIndicator(false);
                    showLoginScreen();
                    return; 
                }

                try {
                    const SCRIPT_URL_WITH_TOKEN_BASE = `${SCRIPT_URL}?sessionToken=${encodeURIComponent(token)}`;

                    const fetchData = async (action, targetArrayName) => {
                        try {
                            const response = await fetch(`${SCRIPT_URL_WITH_TOKEN_BASE}&action=${action}`);
                            const result = await response.json();
                            if (result.status === "success") {
                                window[targetArrayName] = result.data || []; 
                            } else {
                                console.error(`Error ${action}:`, result.message, result.details);
                                showToast(`Error ${action}: ${result.message || 'Desconocido'}`, "error", 5000);
                                window[targetArrayName] = [];
                                if (result.message && (result.message.toLowerCase().includes("unauthorized") || (result.details && result.details.toLowerCase().includes("unauthorized")))) {
                                    throw new Error("Unauthorized"); 
                                }
                            }
                        } catch (e) {
                           console.error(`Fetch error en ${action}:`, e);
                           showToast(`Error de red en ${action}.`, "error", 5000);
                           window[targetArrayName] = [];
                           if (e.message === "Unauthorized") throw e; 
                        }
                    };
                    
                    await Promise.all([
                        fetchData('getClientes', 'clientes_data'),
                        fetchData('getTareas', 'tareas_data'),
                        fetchData('getPublicaciones', 'publicaciones_data'),
                        fetchData('getPaquetesServicios', 'paquetes_servicios_data'),
                        fetchData('getIngresos', 'ingresos_data'),
                        fetchData('getCuentasPorCobrar', 'cuentas_cobrar_data'),
                        fetchData('getCuentasEmpresa', 'cuentas_empresa_data')
                    ]);

                } catch (error) {
                    if (error.message === "Unauthorized") {
                        clearSessionAndShowLogin();
                    } else {
                        console.error("Error crítico fetchInitialData:", error);
                        showToast("Error crítico carga inicial.", "error", 7000);
                        ['clientes_data', 'tareas_data', 'publicaciones_data', 'paquetes_servicios_data', 'ingresos_data', 'cuentas_cobrar_data', 'cuentas_empresa_data'].forEach(arrName => window[arrName] = []);
                    }
                } finally {
                    showLoadingIndicator(false);
                    if (localStorage.getItem(SESSION_TOKEN_KEY)) { 
                        poblarSelectorClientesTarea();
                        poblarSelectoresClientePublicaciones();
                        poblarSelectPaquetesServicio();
                        poblarSelectorClienteIngresos();
                        poblarSelectorClienteCuentasCobrar();

                        const hash = window.location.hash;
                        let targetId = 'dashboard'; // CORREGIDO: Default a dashboard
                        let clienteId = null;

                        if (hash && hash !== '#') { 
                            if (hash.startsWith('#perfil-cliente?id=')) {
                                targetId = 'perfil-cliente';
                                clienteId = hash.substring('#perfil-cliente?id='.length);
                                vistaAnterior = '#clientes'; 
                            } else { 
                                const potentialTargetId = hash.substring(1);
                                if (document.getElementById(potentialTargetId)) { // Verificar si la sección existe
                                    targetId = potentialTargetId;
                                }
                                // Si no es perfil cliente ni una sección válida, se mantendrá 'dashboard'
                            }
                        }
                        showSection(targetId, clienteId); 
                    }
                }
            }


            async function guardarClienteEnSheets(clienteData) { const esNuevo = !clientes_data.some(c => c.id === clienteData.id); const result = await saveDataToSheets("saveCliente", clienteData); if (result.success) { const updatedCliente = result.data; let nombreClienteAnterior = null; if (esNuevo) clientes_data.push(updatedCliente); else { const index = clientes_data.findIndex(c => c.id === updatedCliente.id); if (index !== -1) {nombreClienteAnterior = clientes_data[index].nombre; clientes_data[index] = updatedCliente;} else clientes_data.push(updatedCliente); } if (!esNuevo && nombreClienteAnterior !== updatedCliente.nombre) { publicaciones_data.forEach(pub => { if (pub.clienteId === updatedCliente.id) pub.clienteNombre = updatedCliente.nombre; }); ingresos_data.forEach(ing => { if (ing.clienteId === updatedCliente.id) ing.clienteNombre = updatedCliente.nombre; }); cuentas_cobrar_data.forEach(cc => { if(cc.clienteId === updatedCliente.id) cc.clienteNombre = updatedCliente.nombre;}); if (document.getElementById('publicaciones') && document.getElementById('publicaciones').offsetParent !== null) aplicarFiltrosPublicaciones(); if (document.getElementById('administracion') && document.getElementById('administracion').offsetParent !== null) {aplicarFiltrosIngresos(); aplicarFiltrosCuentasCobrar();}} poblarSelectoresClientePublicaciones(); poblarSelectorClienteIngresos(); poblarSelectorClienteCuentasCobrar(); actualizarComponentesDashboard(); } return result.success; }
            async function eliminarClienteDeSheets(clienteId) { const result = await saveDataToSheets("deleteCliente", { id: clienteId }); if (result.success) { clientes_data = clientes_data.filter(c => c.id !== clienteId); let pubMod = false; publicaciones_data.forEach(pub => { if(String(pub.clienteId) === String(clienteId)) { pub.clienteNombre = "Cliente Eliminado"; pub.clienteId = ""; pubMod = true;}}); if(pubMod && document.getElementById('publicaciones') && document.getElementById('publicaciones').offsetParent !== null) aplicarFiltrosPublicaciones(); let ingMod = false; ingresos_data.forEach(ing => {if(String(ing.clienteId) === String(clienteId)) { ing.clienteNombre = "Cliente Eliminado"; ing.clienteId = ""; ingMod = true;}}); if(ingMod && document.getElementById('administracion') && document.getElementById('administracion').offsetParent !== null) aplicarFiltrosIngresos(); let ccMod = false; cuentas_cobrar_data.forEach(cc => {if(String(cc.clienteId) === String(clienteId)) { cc.clienteNombre = "Cliente Eliminado"; cc.clienteId = ""; ccMod = true;}}); if(ccMod && document.getElementById('administracion') && document.getElementById('administracion').offsetParent !== null) aplicarFiltrosCuentasCobrar(); poblarSelectoresClientePublicaciones(); poblarSelectorClienteIngresos(); poblarSelectorClienteCuentasCobrar(); actualizarComponentesDashboard(); detallePerfilClientePreviewEl.classList.add('hidden'); detallePerfilClientePreviewEl.innerHTML = ''; poblarSelectorClientesTarea(); if (!perfilDedicadoSection.classList.contains('hidden') && clienteSeleccionadoPerfilDedicadoId === clienteId) window.location.hash = '#dashboard'; } return result.success; }
            async function guardarTareaEnSheets(tareaData) { return await saveDataToSheets("saveTarea", tareaData); }
            async function eliminarTareaDeSheets(tareaId) { return await saveDataToSheets("deleteTarea", { id: tareaId });}
            async function guardarPublicacionEnSheets(publicacionData) { const esNuevo = !publicacionData.id || !publicaciones_data.some(p => p.id === publicacionData.id); const result = await saveDataToSheets("savePublicacion", publicacionData); if (result.success) { const updatedPublicacion = result.data; if (esNuevo) publicaciones_data.push(updatedPublicacion); else { const index = publicaciones_data.findIndex(p => p.id === updatedPublicacion.id); if (index !== -1) publicaciones_data[index] = updatedPublicacion; else publicaciones_data.push(updatedPublicacion); } } return result.success; }
            async function eliminarPublicacionDeSheets(publicacionId) { const result = await saveDataToSheets("deletePublicacion", { id: publicacionId }); if (result.success) publicaciones_data = publicaciones_data.filter(p => p.id !== publicacionId); return result.success; }
            async function guardarPaqueteServicioEnSheets(paqueteData) { const result = await saveDataToSheets("savePaqueteServicio", paqueteData); if (result.success) { paquetes_servicios_data.push(result.data); } return result.success; }
            async function guardarIngresoEnSheets(ingresoData) { const result = await saveDataToSheets("saveIngreso", ingresoData); if (result.success) { ingresos_data.push(result.data); } return result.success; }
            async function eliminarIngresoDeSheets(ingresoId) { const result = await saveDataToSheets("deleteIngreso", { id: ingresoId }); if (result.success) { ingresos_data = ingresos_data.filter(i => i.id !== ingresoId); } return result.success;}
            async function guardarCuentaPorCobrarEnSheets(cuentaData) { const result = await saveDataToSheets("saveCuentaPorCobrar", cuentaData); if (result.success) { const esNueva = !cuentas_cobrar_data.some(cc => cc.id === result.data.id); if (esNueva) cuentas_cobrar_data.push(result.data); else { const index = cuentas_cobrar_data.findIndex(cc => cc.id === result.data.id); if (index !== -1) cuentas_cobrar_data[index] = result.data; else cuentas_cobrar_data.push(result.data); } } return result.success; }
            async function eliminarCuentaPorCobrarDeSheets(cuentaId) { const result = await saveDataToSheets("deleteCuentaPorCobrar", { id: cuentaId }); if (result.success) { cuentas_cobrar_data = cuentas_cobrar_data.filter(cc => cc.id !== cuentaId); } return result.success; }
            async function guardarCuentaEmpresaEnSheets(cuentaData) { const result = await saveDataToSheets("saveCuentaEmpresa", cuentaData); if (result.success) { const esNueva = !cuentas_empresa_data.some(ce => ce.id === result.data.id); if (esNueva) cuentas_empresa_data.push(result.data); else { const index = cuentas_empresa_data.findIndex(ce => ce.id === result.data.id); if (index !== -1) cuentas_empresa_data[index] = result.data; else cuentas_empresa_data.push(result.data); }} return result.success;}
            async function eliminarCuentaEmpresaDeSheets(cuentaId) { const result = await saveDataToSheets("deleteCuentaEmpresa", { id: cuentaId }); if (result.success) { cuentas_empresa_data = cuentas_empresa_data.filter(ce => ce.id !== cuentaId); } return result.success; }


            function formatLocalDate(dateString) { if (!dateString) return '-'; let date; if (String(dateString).includes('T')) date = new Date(dateString); else { const parts = String(dateString).split('-'); if (parts.length === 3) date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); else return '-'; } if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }); }
            function showLoadingIndicator(show, message = "Procesando...") { const overlay = document.getElementById('loadingOverlay'); const msgElement = document.getElementById('loadingMessage'); if (overlay && msgElement) { if (show) { msgElement.textContent = message; overlay.style.display = 'flex'; } else overlay.style.display = 'none'; } }

            function updateDashboardCounters() { if (!totalClientesActivosEl) return; totalClientesActivosEl.textContent = clientes_data.length; const hoy = new Date(); hoy.setUTCHours(0,0,0,0); const clientesARevisarCount = clientes_data.filter(c => { if (!c.vencimientoWeb) return false; let v; if(String(c.vencimientoWeb).includes('T')) v=new Date(c.vencimientoWeb); else if (String(c.vencimientoWeb).includes('-')){ const p=String(c.vencimientoWeb).split('-'); v=new Date(Date.UTC(p[0],p[1]-1,p[2]));} else return false; if(isNaN(v.getTime()))return false; v.setUTCHours(0,0,0,0); const dT=v-hoy; const dD=Math.ceil(dT/(1000*60*60*24)); return dD<=30 && dD>=0; }).length; totalClientesRevisarEl.textContent = clientesARevisarCount; const clientesConWeb = clientes_data.filter(c => c.dominioWeb && String(c.dominioWeb).trim() !== '').length; totalServiciosWebEl.textContent = clientesConWeb; const tareasPendientesCount = tareas_data.filter(t => t.estado === 'Pendiente' || t.estado === 'En Progreso').length; totalTareasPendientesEl.textContent = tareasPendientesCount; }
            function renderizarListaPerfilesDashboard() { if (!listaPerfilesClientesEl) return; listaPerfilesClientesEl.innerHTML = ''; detallePerfilClientePreviewEl.classList.add('hidden'); detallePerfilClientePreviewEl.innerHTML = ''; if (clientes_data.length === 0) { listaPerfilesClientesEl.innerHTML = '<p class="text-brand-text-secondary dark:text-slate-400 col-span-full text-center py-4">No hay clientes.</p>'; return; } clientes_data.slice(0, 6).forEach((c) => { const btn = document.createElement('button'); btn.className = 'bg-brand-white dark:bg-slate-700 p-4 rounded-lg shadow hover:shadow-md text-left focus:outline-none focus:ring-2 focus:ring-brand-primary dark:focus:ring-primary-light btn content-card-modern'; btn.dataset.clienteId = c.id; btn.innerHTML = `<h4 class="font-semibold text-brand-primary dark:text-primary-light">${c.nombre}</h4><p class="text-sm text-brand-text-secondary dark:text-slate-400">${c.clinica || 'Sin clínica'}</p>`; btn.addEventListener('click', mostrarDetallePerfilPreview); listaPerfilesClientesEl.appendChild(btn); }); }
            function mostrarDetallePerfilPreview(e) { const cId = e.currentTarget.dataset.clienteId; const c = clientes_data.find(cl => cl.id === cId); if (!c) return; let sH = ''; if (c.serviciosContratados && Array.isArray(c.serviciosContratados) && c.serviciosContratados.length > 0) { sH = c.serviciosContratados.slice(0,2).map(s => `<p class="text-xs text-brand-text-secondary dark:text-slate-400 truncate"> - ${s.nombreServicio} (${s.tipoCobro})</p>`).join(''); if(c.serviciosContratados.length > 2) sH += '<p class="text-xs text-gray-400 dark:text-slate-500">...</p>';} else sH = '<p class="text-xs text-brand-text-secondary dark:text-slate-400">Sin paquetes.</p>'; detallePerfilClientePreviewEl.innerHTML = `<button id="btnCerrarDetallePerfilPreview" class="float-right text-brand-text-secondary dark:text-slate-400 hover:text-danger text-2xl leading-none btn mb-2">&times;</button><h3 class="text-lg font-bold text-brand-primary dark:text-primary-light mb-3">${c.nombre}</h3><div class="space-y-1 text-sm mb-4"><p><strong>Clínica:</strong> ${c.clinica||'-'}</p><p><strong>Email:</strong> ${c.email||'-'}</p><p><strong>Teléfono:</strong> ${c.telefono||'-'}</p><div class="mt-2"><p class="font-medium text-brand-text-primary dark:text-slate-200">Servicios Contratados:</p>${sH}</div></div><button data-cliente-id="${c.id}" class="w-full btn btn-primary-modern ver-perfil-completo-btn">Ver Perfil Completo</button>`; detallePerfilClientePreviewEl.classList.remove('hidden'); document.getElementById('btnCerrarDetallePerfilPreview').addEventListener('click', () => { detallePerfilClientePreviewEl.classList.add('hidden'); detallePerfilClientePreviewEl.innerHTML = ''; }); detallePerfilClientePreviewEl.querySelector('.ver-perfil-completo-btn').addEventListener('click', handleVerPerfilDedicado); }
            function renderizarTareasUrgentesDashboard() { if (!listaTareasUrgentesDashboardEl) return; listaTareasUrgentesDashboardEl.innerHTML = ''; const hoy = new Date(); const manana = new Date(); hoy.setUTCHours(0,0,0,0); manana.setUTCDate(hoy.getUTCDate() + 1); manana.setUTCHours(0,0,0,0); const tareasUrgentes = tareas_data.filter(t => { if (!t.fechaEntrega || String(t.fechaEntrega).trim()==="" || (t.estado && t.estado.toLowerCase()==='completada')) return false; let fechaT; if(String(t.fechaEntrega).includes('T')) fechaT = new Date(t.fechaEntrega); else { const p=String(t.fechaEntrega).split('-'); if(p.length===3) fechaT = new Date(Date.UTC(p[0],p[1]-1,p[2])); else return false;} if(isNaN(fechaT.getTime())) return false; fechaT.setUTCHours(0,0,0,0); return fechaT.getTime()===hoy.getTime() || fechaT.getTime()===manana.getTime(); }).sort((a,b)=>{ let dA,dB; const pA=String(a.fechaEntrega).split('-'); dA=new Date(Date.UTC(pA[0],pA[1]-1,pA[2])); const pB=String(b.fechaEntrega).split('-'); dB=new Date(Date.UTC(pB[0],pB[1]-1,pB[2])); if(dA < dB) return -1; if(dA > dB) return 1; return a.nombre.localeCompare(b.nombre);}); if(tareasUrgentes.length===0){listaTareasUrgentesDashboardEl.innerHTML='<li class="text-brand-text-secondary dark:text-slate-400 italic">No hay tareas urgentes.</li>'; return;} tareasUrgentes.forEach(t=>{const li=document.createElement('li');li.className='p-3 bg-brand-light-bg dark:bg-slate-700 rounded-md shadow-sm flex justify-between items-center';let fE='';let fTD;const p=String(t.fechaEntrega).split('-');fTD=new Date(Date.UTC(p[0],p[1]-1,p[2]));fTD.setUTCHours(0,0,0,0);if(fTD.getTime()===hoy.getTime())fE='<span class="text-xs font-semibold px-2 py-1 bg-danger text-white rounded-full">HOY</span>';else if(fTD.getTime()===manana.getTime())fE='<span class="text-xs font-semibold px-2 py-1 bg-warning text-brand-text-primary dark:text-yellow-800 dark:bg-yellow-300 rounded-full">MAÑANA</span>';const cA=t.clienteId&&clientes_data.find(c=>c.id===t.clienteId);const nC=cA?cA.nombre:'General';li.innerHTML=`<div><span class="font-medium text-brand-text-primary dark:text-slate-200">${t.nombre}</span><span class="block text-xs text-brand-text-secondary dark:text-slate-400">Cliente: ${nC} - Estado: ${t.estado}</span></div>${fE}`;listaTareasUrgentesDashboardEl.appendChild(li);});}
            function renderizarServiciosPorVencerDashboard() { if (!listaServiciosPorVencerDashboardEl) return; listaServiciosPorVencerDashboardEl.innerHTML = ''; const hoy = new Date(); hoy.setUTCHours(0,0,0,0); const servPorVencer = clientes_data.filter(c => { if (!c.vencimientoWeb || String(c.vencimientoWeb).trim()==="") return false; let v; if(String(c.vencimientoWeb).includes('T'))v=new Date(c.vencimientoWeb); else if(String(c.vencimientoWeb).includes('-')){const p=String(c.vencimientoWeb).split('-');v=new Date(Date.UTC(p[0],p[1]-1,p[2]));} else return false; if(isNaN(v.getTime()))return false;v.setUTCHours(0,0,0,0);const dT=v.getTime()-hoy.getTime();const dD=Math.ceil(dT/(1000*60*60*24));return dD<=30&&dD>=0;}).sort((a,b)=>{let dA,dB;const pA=String(a.vencimientoWeb).split('-');dA=new Date(Date.UTC(pA[0],pA[1]-1,pA[2]));const pB=String(b.vencimientoWeb).split('-');dB=new Date(Date.UTC(pB[0],pB[1]-1,pB[2]));return dA-dB;}); if(servPorVencer.length===0){listaServiciosPorVencerDashboardEl.innerHTML='<li class="text-brand-text-secondary dark:text-slate-400 italic">No hay servicios web próximos a vencer.</li>';return;} servPorVencer.slice(0,5).forEach(c=>{const li=document.createElement('li');li.className='p-3 bg-brand-light-bg dark:bg-slate-700 rounded-md shadow-sm';let fVD;const p=String(c.vencimientoWeb).split('-');fVD=new Date(Date.UTC(p[0],p[1]-1,p[2]));const dT=fVD.getTime()-hoy.getTime();const dD=Math.ceil(dT/(1000*60*60*24));let cU="text-success dark:text-green-400";if(dD<=7)cU="text-danger dark:text-red-400";else if(dD<=15)cU="text-warning dark:text-yellow-400";li.innerHTML=`<span class="font-medium text-brand-text-primary dark:text-slate-200">${c.nombre}</span><span class="block text-xs text-brand-text-secondary dark:text-slate-400">Dominio: ${c.dominioWeb||'N/A'}</span><span class="block text-xs ${cU} font-semibold">Vence en ${dD} día(s) (${formatLocalDate(c.vencimientoWeb)})</span>`;listaServiciosPorVencerDashboardEl.appendChild(li);});}
            function renderizarProximasTareasDashboard() { if (!listaProximasTareasDashboardEl) return; listaProximasTareasDashboardEl.innerHTML = ''; const hoy = new Date(); hoy.setUTCHours(0, 0, 0, 0); const proximasTareas = tareas_data.filter(t => { if (!t.fechaEntrega || String(t.fechaEntrega).trim() === "" || (t.estado && t.estado.toLowerCase() === 'completada')) return false; let fechaT; if (String(t.fechaEntrega).includes('T')) fechaT = new Date(t.fechaEntrega); else { const parts = String(t.fechaEntrega).split('-'); if (parts.length === 3) fechaT = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); else return false; } if (isNaN(fechaT.getTime())) return false; fechaT.setUTCHours(0,0,0,0); return fechaT.getTime() >= hoy.getTime(); }).sort((a, b) => { let dA, dB; const pA=String(a.fechaEntrega).split('-'); dA=new Date(Date.UTC(pA[0],pA[1]-1,pA[2])); const pB=String(b.fechaEntrega).split('-'); dB=new Date(Date.UTC(pB[0],pB[1]-1,pB[2])); if(dA < dB) return -1; if(dA > dB) return 1; return a.nombre.localeCompare(b.nombre); }).slice(0, 3); if (proximasTareas.length === 0) { listaProximasTareasDashboardEl.innerHTML = '<li class="text-brand-text-secondary dark:text-slate-400 italic">No hay tareas próximas.</li>'; return; } proximasTareas.forEach(t => { const li = document.createElement('li'); li.className = 'text-brand-text-secondary dark:text-slate-400 hover:text-brand-primary dark:hover:text-primary-light'; const cA=t.clienteId&&clientes_data.find(c => c.id === t.clienteId); const nC=cA?cA.nombre:'General'; li.innerHTML = `<span class="font-medium">${t.nombre}</span> - ${nC} (${formatLocalDate(t.fechaEntrega)})`; listaProximasTareasDashboardEl.appendChild(li); }); }
            function actualizarComponentesDashboard() { if (document.getElementById('dashboard') && document.getElementById('dashboard').offsetParent !== null) { updateDashboardCounters(); renderizarListaPerfilesDashboard(); renderizarTareasUrgentesDashboard(); renderizarServiciosPorVencerDashboard(); renderizarProximasTareasDashboard(); actualizarCalendario(); }}

            function inicializarCalendario() { if (calendarInstance && typeof calendarInstance.destroy === 'function') { calendarInstance.destroy(); calendarInstance = null; } if (!calendarContainer || calendarContainer.offsetParent === null) return; const hoy = new Date(); const fechasTareasMarcadas = tareas_data.filter(t => t.fechaEntrega && String(t.fechaEntrega).trim() !== "").map(t => ({ date: String(t.fechaEntrega) })); try { if (typeof VanillaCalendar === 'undefined') { console.error("VanillaCalendar no está definido."); return; } calendarInstance = new VanillaCalendar(calendarContainer, { settings: { lang: 'es', iso8601: false, range: { disablePast: false }, selection: { day: 'single' }, visibility: { theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light', weekend: true, today: true }}, date: { today: hoy }, dates: fechasTareasMarcadas, actions: { clickDay(e, dates) { if (dates[0]) { const fechaClic = dates[0]; const tareasDelDia = tareas_data.filter(t => String(t.fechaEntrega) === fechaClic); if (tareasDelDia.length > 0) { const nombresTareas = tareasDelDia.map(t => `- ${t.nombre} (${t.estado})`).join('\n'); showToast(`Tareas para ${formatLocalDate(fechaClic)}:\n${nombresTareas.substring(0,150)}${nombresTareas.length > 150 ? '...' : ''}`, "info", 7000); } } } } }); calendarInstance.init(); } catch (error) { console.error("Error al inicializar el calendario:", error, error.stack); } }
            function actualizarCalendario() { if (!calendarContainer || calendarContainer.offsetParent === null) return; inicializarCalendario(); }

            function showSection(targetId, clienteId = null) {
                pageSections.forEach(s => { 
                    if (s && !s.classList.contains('hidden')) s.classList.add('hidden'); 
                }); 
                
                let sectionToShowId = targetId; 
                let isPerfilDedicado = false; 
                const targetEl = document.getElementById(targetId); 
                
                if (targetId === 'perfil-cliente' && clienteId) { 
                    const perfilS = document.getElementById('perfil-cliente-dedicado'); 
                    if (perfilS) { 
                        clienteSeleccionadoPerfilDedicadoId = clienteId; 
                        mostrarPerfilDedicado(clienteId); 
                        perfilS.classList.remove('hidden'); 
                        isPerfilDedicado = true; 
                        sectionToShowId = 'perfil-cliente-dedicado'; 
                    } else { 
                        console.error("Sección perfil-cliente-dedicado no encontrada"); 
                        sectionToShowId = 'dashboard'; 
                        const dashboardEl = document.getElementById('dashboard');
                        if(dashboardEl) dashboardEl.classList.remove('hidden');
                    }
                } else if (targetEl) { 
                    targetEl.classList.remove('hidden'); 
                    sectionToShowId = targetId; 
                } else { 
                    const dashboardEl = document.getElementById('dashboard'); // Fallback a dashboard si targetId no existe
                    if(dashboardEl) dashboardEl.classList.remove('hidden');
                    sectionToShowId = 'dashboard';
                } 
                
                navLinks.forEach(l => { 
                    const hrefAttr = l.getAttribute('href');
                    if (hrefAttr) {
                        const lT = hrefAttr.substring(1); 
                        l.classList.toggle('active', lT === sectionToShowId || (isPerfilDedicado && lT === 'clientes')); 
                    }
                }); 
                
                if (sectionToShowId === 'dashboard') actualizarComponentesDashboard(); 
                if (sectionToShowId === 'clientes') renderizarClientesResumen(); 
                if (sectionToShowId === 'tareas') renderizarTareas(); 
                if (sectionToShowId === 'publicaciones') { poblarSelectoresClientePublicaciones(); aplicarFiltrosPublicaciones(); } 
                if (sectionToShowId === 'paquetes-servicios') renderizarPaquetesServicios(); 
                if (sectionToShowId === 'servicios-web') renderizarServiciosWeb(); 
                if (sectionToShowId === 'administracion') { poblarSelectorClienteIngresos(); aplicarFiltrosIngresos(); poblarSelectorClienteCuentasCobrar(); aplicarFiltrosCuentasCobrar(); renderizarTablaCuentasEmpresa(); }
            }


            function handleVerPerfilDedicado(e) { const clienteId = e.currentTarget.dataset.clienteId; if (clienteId) { vistaAnterior = window.location.hash || '#dashboard'; window.location.hash = `#perfil-cliente?id=${clienteId}`; } }
            function mostrarPerfilDedicado(clienteId) { const cliente = clientes_data.find(c => c.id === clienteId); if (!cliente) { showToast("Cliente no encontrado.", "error"); window.location.hash = '#clientes'; return; } nombrePerfilDedicadoEl.textContent = cliente.nombre; perfilDedicadoClinicaEl.textContent = cliente.clinica || '-'; perfilDedicadoEmailEl.textContent = cliente.email || '-'; perfilDedicadoTelefonoEl.textContent = cliente.telefono || '-'; perfilDedicadoPagadoEl.textContent = `$${(parseFloat(cliente.pagado) || 0).toFixed(2)}`; perfilDedicadoNotasEl.textContent = cliente.notas || '-'; perfilDedicadoServiciosContratadosUl.innerHTML = ''; if (cliente.serviciosContratados && Array.isArray(cliente.serviciosContratados) && cliente.serviciosContratados.length > 0) { cliente.serviciosContratados.forEach(s => { const li = document.createElement('li'); li.innerHTML = `<strong>${s.nombreServicio}</strong> (Cobro: ${s.tipoCobro} - $${s.monto})`; perfilDedicadoServiciosContratadosUl.appendChild(li); }); } else { perfilDedicadoServiciosContratadosUl.innerHTML = '<li>No hay paquetes.</li>'; } perfilDedicadoDominioWebEl.textContent = cliente.dominioWeb || '-'; perfilDedicadoTipoWebEl.textContent = cliente.tipoServicioWeb || '-'; perfilDedicadoVencimientoWebEl.textContent = formatLocalDate(cliente.vencimientoWeb); perfilDedicadoConfigRedesDiv.innerHTML = ''; let confRedesHTML = '';  if (cliente.plataformasRedes || cliente.detallesRedes) { confRedesHTML += `<div class="sub-section"><h4>Redes Sociales (General)</h4><p><strong>Plataformas:</strong> ${cliente.plataformasRedes || '-'}</p><p><strong>Detalles/Estrategia:</strong><br><span class="whitespace-pre-wrap">${cliente.detallesRedes || '-'}</span></p></div>`; } perfilDedicadoConfigRedesDiv.innerHTML = confRedesHTML || '<p class="text-xs text-brand-text-secondary dark:text-slate-400">Sin info general de redes.</p>'; perfilDedicadoTareasUl.innerHTML = ''; const tareasCliente = tareas_data.filter(t => String(t.clienteId) === String(clienteId)); if (tareasCliente.length > 0) { tareasCliente.forEach(t => { const li = document.createElement('li'); let eCol = 'text-brand-text-secondary dark:text-slate-400'; if(t.estado==='Pendiente')eCol='text-warning dark:text-yellow-400'; else if(t.estado==='En Progreso')eCol='text-info dark:text-blue-400'; else if(t.estado==='Completada')eCol='text-success dark:text-green-400'; li.innerHTML = `<strong>${t.nombre}</strong> - <span class="${eCol} font-semibold">${t.estado}</span> ${t.fechaEntrega ? `(Entrega: ${formatLocalDate(t.fechaEntrega)})` : ''}`; perfilDedicadoTareasUl.appendChild(li); }); } else { perfilDedicadoTareasUl.innerHTML = '<li>Sin tareas.</li>'; } }
            if(btnVolverDesdePerfil) btnVolverDesdePerfil.addEventListener('click', () => { window.location.hash = vistaAnterior; });
            if(btnEditarDesdePerfil) btnEditarDesdePerfil.addEventListener('click', () => { if (clienteSeleccionadoPerfilDedicadoId) { const idx = clientes_data.findIndex(c => c.id === clienteSeleccionadoPerfilDedicadoId); if (idx !== -1) abrirModalCliente(true, idx); else showToast("Error: Cliente no encontrado para editar.", "error"); } });

            function renderizarServiciosContratadosEnModal(servicios) { serviciosContratadosContainer.innerHTML = ''; if (!servicios || !Array.isArray(servicios) || servicios.length === 0) { serviciosContratadosContainer.innerHTML = '<p class="text-sm text-brand-text-secondary dark:text-slate-400">No hay paquetes.</p>'; return; } servicios.forEach((s, i) => { const d = document.createElement('div'); d.className = 'flex justify-between items-center p-2 bg-brand-light-bg dark:bg-slate-700 rounded-md'; d.innerHTML = `<div><p class="font-medium text-sm">${s.nombreServicio}</p><p class="text-xs text-brand-text-secondary dark:text-slate-400">Cobro: ${s.tipoCobro} - Monto: $${(parseFloat(s.monto)||0).toFixed(2)}</p></div><button type="button" data-index="${i}" class="text-danger hover:text-red-700 font-semibold text-sm btnRemoveServicioContratado">&times; Quitar</button>`; serviciosContratadosContainer.appendChild(d); }); document.querySelectorAll('.btnRemoveServicioContratado').forEach(b => { b.addEventListener('click', (e) => { const sIdx = parseInt(e.target.dataset.index); tempServiciosContratados.splice(sIdx, 1); renderizarServiciosContratadosEnModal(tempServiciosContratados); }); }); }
            function poblarSelectPaquetesServicio() { if (!selectPaqueteServicio) return; const valorActual = selectPaqueteServicio.value; selectPaqueteServicio.innerHTML = '<option value="">Seleccionar paquete...</option>'; paquetes_servicios_data.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.textContent = p.nombre; selectPaqueteServicio.appendChild(o); }); if(paquetes_servicios_data.find(p => p.id === valorActual)) selectPaqueteServicio.value = valorActual;}
            if(btnAddServicioContratado) btnAddServicioContratado.addEventListener('click', () => { const pId = selectPaqueteServicio.value; const m = montoPaqueteServicioInput.value; const tC = tipoCobroPaqueteServicioSelect.value; if (!pId) { showToast('Seleccione paquete.', "warning"); return; } if (!m || parseFloat(m) <= 0) { showToast('Monto válido.', "warning"); return; } const pSel = paquetes_servicios_data.find(p => p.id === pId); if (pSel) { if (tempServiciosContratados.find(s => s.idServicio === pId)) { showToast('Paquete ya añadido.', "info"); return; } tempServiciosContratados.push({ idServicio: pSel.id, nombreServicio: pSel.nombre, monto: parseFloat(m).toFixed(2), tipoCobro: tC }); renderizarServiciosContratadosEnModal(tempServiciosContratados); selectPaqueteServicio.value = ''; montoPaqueteServicioInput.value = ''; } });
            function abrirModalCliente(esEdicion = false, index = null) { formCliente.reset(); editandoClienteIndex = null; tempServiciosContratados = []; poblarSelectPaquetesServicio(); if (esEdicion && index !== null && clientes_data[index]) { modalClienteTitle.textContent = 'Editar Cliente'; const c = clientes_data[index]; document.getElementById('nombreCliente').value = c.nombre; document.getElementById('clinicaCliente').value = c.clinica||''; document.getElementById('emailCliente').value = c.email||''; document.getElementById('telefonoCliente').value = c.telefono||''; document.getElementById('serviciosActivosGeneralCliente').value = c.serviciosActivosGeneral||''; document.getElementById('pagadoCliente').value = c.pagado||0; document.getElementById('notasCliente').value = c.notas||''; document.getElementById('dominioWebCliente').value = c.dominioWeb||''; document.getElementById('tipoServicioWebCliente').value = c.tipoServicioWeb||''; document.getElementById('vencimientoWebCliente').value = c.vencimientoWeb||''; document.getElementById('plataformasRedesCliente').value = c.plataformasRedes||''; document.getElementById('detallesRedesCliente').value = c.detallesRedes||''; tempServiciosContratados = (Array.isArray(c.serviciosContratados) ? [...c.serviciosContratados] : []); editandoClienteIndex = index; } else { modalClienteTitle.textContent = 'Añadir Cliente'; tempServiciosContratados = []; editandoClienteIndex = null; } renderizarServiciosContratadosEnModal(tempServiciosContratados); modalCliente.classList.add('active'); void modalCliente.offsetWidth; modalClienteContent.style.transform = 'translateY(0)'; document.getElementById('nombreCliente').focus(); }
            function cerrarModalCliente() { modalClienteContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalCliente.classList.remove('active'); formCliente.reset(); editandoClienteIndex = null; tempServiciosContratados = [];}, 300); }
            formCliente.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try { const idC = (editandoClienteIndex !== null && clientes_data[editandoClienteIndex]) ? clientes_data[editandoClienteIndex].id : 'cliente_' + Date.now(); let dC = { id: idC, nombre: document.getElementById('nombreCliente').value.trim(), clinica: document.getElementById('clinicaCliente').value.trim(), email: document.getElementById('emailCliente').value.trim(), telefono: document.getElementById('telefonoCliente').value.trim(), serviciosActivosGeneral: document.getElementById('serviciosActivosGeneralCliente').value.trim(), pagado: parseFloat(document.getElementById('pagadoCliente').value) || 0, notas: document.getElementById('notasCliente').value.trim(), dominioWeb: document.getElementById('dominioWebCliente').value.trim(), tipoServicioWeb: document.getElementById('tipoServicioWebCliente').value.trim(), vencimientoWeb: document.getElementById('vencimientoWebCliente').value, plataformasRedes: document.getElementById('plataformasRedesCliente').value.trim(), detallesRedes: document.getElementById('detallesRedesCliente').value.trim(), serviciosContratados: [...tempServiciosContratados] };  dC.configuracionRedes = (editandoClienteIndex !== null && clientes_data[editandoClienteIndex] && clientes_data[editandoClienteIndex].configuracionRedes) ? clientes_data[editandoClienteIndex].configuracionRedes : {}; if (dC.nombre === "") { showToast("Nombre cliente obligatorio.", "warning"); document.getElementById('nombreCliente').focus(); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; return; } const guardadoOK = await guardarClienteEnSheets(dC); if (guardadoOK) { showToast(editandoClienteIndex !== null ? "Cliente actualizado" : "Cliente añadido", "success"); renderizarClientesResumen(); cerrarModalCliente(); poblarSelectorClientesTarea(); poblarSelectoresClientePublicaciones(); poblarSelectorClienteIngresos(); poblarSelectorClienteCuentasCobrar(); if (!perfilDedicadoSection.classList.contains('hidden') && clienteSeleccionadoPerfilDedicadoId === dC.id) mostrarPerfilDedicado(dC.id); }} catch (error) {console.error("Error en submit formCliente:", error); showToast("Ocurrió un error al guardar.", "error");} finally { submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});
            function handleEditarCliente(e) { const index = parseInt(e.target.dataset.originalIndex); abrirModalCliente(true, index); }
            async function handleEliminarCliente(e) { const oIdx = parseInt(e.target.dataset.originalIndex); const cAE = clientes_data[oIdx]; if (cAE) { mostrarModalConfirmacion( "Confirmar Eliminación", `¿Seguro que quieres eliminar a ${cAE.nombre}? Esta acción no se puede deshacer.`, async () => { const cIdE = cAE.id; const elimOK = await eliminarClienteDeSheets(cIdE); if (elimOK) { showToast("Cliente eliminado", "success"); renderizarClientesResumen(); let pubMod = false; publicaciones_data.forEach(pub => { if(String(pub.clienteId) === String(cIdE)) { pub.clienteNombre = "Cliente Eliminado"; pub.clienteId = ""; pubMod = true;}}); if(pubMod && document.getElementById('publicaciones') && document.getElementById('publicaciones').offsetParent !== null) aplicarFiltrosPublicaciones(); let ingMod = false; ingresos_data.forEach(ing => {if(String(ing.clienteId) === String(cIdE)) { ing.clienteNombre = "Cliente Eliminado"; ing.clienteId = ""; ingMod = true;}}); if(ingMod && document.getElementById('administracion') && document.getElementById('administracion').offsetParent !== null) aplicarFiltrosIngresos(); let ccMod = false; cuentas_cobrar_data.forEach(cc => {if(String(cc.clienteId) === String(cIdE)) { cc.clienteNombre = "Cliente Eliminado"; cc.clienteId = ""; ccMod = true;}}); if(ccMod && document.getElementById('administracion') && document.getElementById('administracion').offsetParent !== null) aplicarFiltrosCuentasCobrar(); poblarSelectoresClientePublicaciones(); poblarSelectorClienteIngresos(); poblarSelectorClienteCuentasCobrar(); actualizarComponentesDashboard(); detallePerfilClientePreviewEl.classList.add('hidden'); detallePerfilClientePreviewEl.innerHTML = ''; poblarSelectorClientesTarea(); if (!perfilDedicadoSection.classList.contains('hidden') && clienteSeleccionadoPerfilDedicadoId === cIdE) window.location.hash = '#dashboard'; }}, "Eliminar Cliente", "bg-danger hover:bg-red-700");}}

            function renderizarClientesResumen(lista = clientes_data) { if (!tablaClientesBody) return; tablaClientesBody.innerHTML = ''; if (lista.length === 0) { const msg = buscadorClientesInput.value.trim() !== '' ? 'No se encontraron clientes.' : 'No hay clientes. ¡Añade el primero!'; tablaClientesBody.innerHTML = `<tr><td colspan="5" class="text-center py-3">${msg}</td></tr>`; return; } lista.forEach((c) => { const oIdx = clientes_data.findIndex(cl => cl.id === c.id); const tr = document.createElement('tr'); tr.innerHTML = `<td class="font-medium text-brand-text-primary dark:text-slate-200">${c.nombre||'-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${c.clinica||'-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${c.serviciosActivosGeneral||'-'}</td><td class="text-brand-text-secondary dark:text-slate-400">$${(parseFloat(c.pagado)||0).toFixed(2)}</td><td class="text-right text-sm font-medium"><button data-cliente-id="${c.id}" class="ver-perfil-btn font-semibold mr-3">Ver Perfil</button><button data-original-index="${oIdx}" class="editar-cliente-btn font-semibold mr-3">Editar</button><button data-original-index="${oIdx}" class="eliminar-cliente-btn font-semibold">Eliminar</button></td>`; tablaClientesBody.appendChild(tr); }); document.querySelectorAll('.ver-perfil-btn').forEach(b=>b.addEventListener('click',handleVerPerfilDedicado)); document.querySelectorAll('.editar-cliente-btn').forEach(b=>b.addEventListener('click',handleEditarCliente)); document.querySelectorAll('.eliminar-cliente-btn').forEach(b=>b.addEventListener('click',handleEliminarCliente)); }
            function renderizarServiciosWeb() { const tabla = document.getElementById('tablaServiciosWebBody'); if(!tabla) return; tabla.innerHTML = ''; const cW = clientes_data.filter(c => c.dominioWeb && String(c.dominioWeb).trim() !== ''); if (cW.length === 0) { tabla.innerHTML = '<tr><td colspan="4" class="text-center py-3">Ningún cliente tiene servicios web registrados.</td></tr>'; return; } cW.forEach(c => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="font-medium text-brand-text-primary dark:text-slate-200">${c.nombre}</td><td class="text-brand-text-secondary dark:text-slate-400">${c.dominioWeb}</td><td class="text-brand-text-secondary dark:text-slate-400">${c.tipoServicioWeb||'-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(c.vencimientoWeb)}</td>`; tabla.appendChild(tr); }); }
            function renderizarPaquetesServicios() { if (!listaPaquetesServiciosEl) return; listaPaquetesServiciosEl.innerHTML = ''; if (paquetes_servicios_data.length === 0) { listaPaquetesServiciosEl.innerHTML = '<p class="text-brand-text-secondary dark:text-slate-400 col-span-full text-center py-4">No hay paquetes de servicios definidos. Añade el primero.</p>'; return; } paquetes_servicios_data.forEach(p => { const card = document.createElement('div'); card.className = 'content-card-modern'; card.innerHTML = `<h3 class="text-lg font-semibold text-brand-primary dark:text-primary-light mb-2">${p.nombre}</h3><p class="text-sm text-brand-text-secondary dark:text-slate-400 mb-1"><strong>Categoría:</strong> ${p.categoria||'N/A'}</p><p class="text-sm text-brand-text-secondary dark:text-slate-400 mb-3">${p.descripcion||'Sin descripción.'}</p>${p.precioSugerido?`<p class="text-sm font-medium text-brand-text-primary dark:text-slate-200">Precio Sug.: $${parseFloat(p.precioSugerido).toFixed(2)}</p>`:''}`; listaPaquetesServiciosEl.appendChild(card); }); }

            function poblarSelectorClientesTarea() { if(!clienteAsociadoTareaSelect) return; const v = clienteAsociadoTareaSelect.value; clienteAsociadoTareaSelect.innerHTML = '<option value="">Ninguno</option>'; clientes_data.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.nombre; clienteAsociadoTareaSelect.appendChild(o); }); if(clientes_data.find(c=>c.id===v)) clienteAsociadoTareaSelect.value=v; else clienteAsociadoTareaSelect.value = "";}
            function abrirModalTarea(esEdicion = false, index = null) { formTarea.reset(); editandoTareaIndex = null; poblarSelectorClientesTarea(); modalTarea.classList.add('active'); void modalTarea.offsetWidth; modalTareaContent.style.transform = 'translateY(0)'; document.getElementById('nombreTarea').focus(); if (esEdicion && index !== null && tareas_data[index]) { modalTareaTitle.textContent = 'Editar Tarea'; const t = tareas_data[index]; document.getElementById('nombreTarea').value = t.nombre; document.getElementById('clienteAsociadoTarea').value = t.clienteId||""; document.getElementById('fechaEntregaTarea').value = t.fechaEntrega; document.getElementById('estadoTarea').value = t.estado; document.getElementById('descripcionTarea').value = t.descripcion||""; editandoTareaIndex = index; } else { modalTareaTitle.textContent = 'Añadir Tarea'; editandoTareaIndex = null; } }
            function cerrarModalTarea() { modalTareaContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalTarea.classList.remove('active'); formTarea.reset(); editandoTareaIndex = null;}, 300); }
            formTarea.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try { const nT = document.getElementById('nombreTarea').value.trim(); if (nT === "") { showToast("Nombre tarea obligatorio.", "warning"); document.getElementById('nombreTarea').focus(); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; return; } const cIdS = document.getElementById('clienteAsociadoTarea').value; const cS = clientes_data.find(c => c.id === cIdS); const dT = { id: (editandoTareaIndex !== null && tareas_data[editandoTareaIndex]) ? tareas_data[editandoTareaIndex].id : ('tarea_' + Date.now() + Math.random().toString(36).substr(2, 5)), nombre: nT, clienteId: cIdS, clienteNombre: cS ? cS.nombre : 'Ninguno', fechaEntrega: document.getElementById('fechaEntregaTarea').value, estado: document.getElementById('estadoTarea').value, descripcion: document.getElementById('descripcionTarea').value.trim() }; const resultadoGuardado = await guardarTareaEnSheets(dT); if (resultadoGuardado.success) { const esNueva = !tareas_data.some(t => t.id === resultadoGuardado.data.id); if(esNueva) tareas_data.push(resultadoGuardado.data); else { const idx = tareas_data.findIndex(t => t.id === resultadoGuardado.data.id); if(idx !== -1) tareas_data[idx] = resultadoGuardado.data; else tareas_data.push(resultadoGuardado.data); } actualizarComponentesDashboard(); showToast(resultadoGuardado.message || (editandoTareaIndex !== null ? "Tarea actualizada" : "Tarea añadida"), "success"); renderizarTareas(); cerrarModalTarea(); if (!perfilDedicadoSection.classList.contains('hidden') && clienteSeleccionadoPerfilDedicadoId === dT.clienteId) mostrarPerfilDedicado(dT.clienteId); }} catch (error) {console.error("Error submit formTarea:", error); showToast("Ocurrió un error.", "error");} finally { submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});
            function renderizarTareas(lista = tareas_data) { if (!tablaTareasBody) return; tablaTareasBody.innerHTML = ''; if (lista.length === 0) { tablaTareasBody.innerHTML = `<tr><td colspan="5" class="text-center py-3">No hay tareas.</td></tr>`; return; } lista.forEach((t) => { const oIdx = tareas_data.findIndex(ta => ta.id === t.id); const tr = document.createElement('tr'); let eCol = 'text-brand-text-primary dark:text-slate-200'; if(t.estado==='Pendiente')eCol='text-warning dark:text-yellow-400'; else if(t.estado==='En Progreso')eCol='text-info dark:text-blue-400'; else if(t.estado==='Completada')eCol='text-success dark:text-green-400'; tr.innerHTML = `<td class="font-medium text-brand-text-primary dark:text-slate-200">${t.nombre}</td><td class="text-brand-text-secondary dark:text-slate-400">${t.clienteNombre||'Ninguno'}</td><td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(t.fechaEntrega)||'-'}</td><td class="font-semibold ${eCol}">${t.estado}</td><td class="text-right text-sm font-medium"><button data-original-index="${oIdx}" class="editar-tarea-btn font-semibold mr-3">Editar</button><button data-original-index="${oIdx}" class="eliminar-tarea-btn font-semibold">Eliminar</button></td>`; tablaTareasBody.appendChild(tr); }); document.querySelectorAll('.editar-tarea-btn').forEach(b=>b.addEventListener('click',handleEditarTarea)); document.querySelectorAll('.eliminar-tarea-btn').forEach(b=>b.addEventListener('click',handleEliminarTarea)); }
            function handleEditarTarea(e) { const index = parseInt(e.target.dataset.originalIndex); abrirModalTarea(true, index); }
            async function handleEliminarTarea(e) { const oIdx = parseInt(e.target.dataset.originalIndex); const tAE = tareas_data[oIdx]; if (tAE) { mostrarModalConfirmacion("Confirmar Eliminación", `¿Eliminar tarea "${tAE.nombre}"?`, async () => {const cIdAf = tAE.clienteId; const tIdE = tAE.id; const resultadoEliminacion = await eliminarTareaDeSheets(tIdE); if (resultadoEliminacion.success) { tareas_data = tareas_data.filter(t=> t.id !== tIdE); actualizarComponentesDashboard(); showToast(resultadoEliminacion.message || "Tarea eliminada", "success"); renderizarTareas(); if (!perfilDedicadoSection.classList.contains('hidden') && clienteSeleccionadoPerfilDedicadoId === cIdAf) mostrarPerfilDedicado(cIdAf); }}, "Eliminar Tarea", "bg-danger hover:bg-red-700");}}

            function poblarSelectoresClientePublicaciones() { if(clientePublicacionSelect){ const vM=clientePublicacionSelect.value; clientePublicacionSelect.innerHTML='<option value="">-- Cliente --</option>'; clientes_data.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nombre;clientePublicacionSelect.appendChild(o);}); if(clientes_data.find(c=>c.id===vM))clientePublicacionSelect.value=vM; else clientePublicacionSelect.value = "";} if(filtroPublicacionesClienteSelect){ const vF=filtroPublicacionesClienteSelect.value; filtroPublicacionesClienteSelect.innerHTML='<option value="">Todos Clientes</option>'; clientes_data.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nombre;filtroPublicacionesClienteSelect.appendChild(o);}); if(clientes_data.find(c=>c.id===vF))filtroPublicacionesClienteSelect.value=vF; else filtroPublicacionesClienteSelect.value = "";} }
            function renderizarTablaPublicaciones(listaCompleta = publicaciones_data) { if(!tablaPublicacionesBody || !paginacionPublicacionesContainer)return; tablaPublicacionesBody.innerHTML=''; const listaOrdenada = [...listaCompleta].sort((a,b)=>{const dA=new Date(`${a.fechaPublicacion}T${a.horaPublicacion||'00:00'}`); const dB=new Date(`${b.fechaPublicacion}T${b.horaPublicacion||'00:00'}`); return dB-dA;}); const startIndex = (currentPagePublicaciones - 1) * itemsPerPagePublicaciones; const itemsParaPaginaActual = listaOrdenada.slice(startIndex, startIndex + itemsPerPagePublicaciones); if(itemsParaPaginaActual.length===0 && listaCompleta.length > 0){tablaPublicacionesBody.innerHTML=`<tr><td colspan="7" class="text-center py-4">No hay publicaciones en esta página.</td></tr>`;} else if(listaCompleta.length===0){tablaPublicacionesBody.innerHTML=`<tr><td colspan="7" class="text-center py-4">No hay publicaciones que coincidan.</td></tr>`;} else { itemsParaPaginaActual.forEach(p=>{const tr=document.createElement('tr'); const ext=p.contenidoTexto?(p.contenidoTexto.substring(0,50)+(p.contenidoTexto.length>50?'...':'')):'-'; let eBg='bg-gray-200 text-gray-700 dark:bg-slate-600 dark:text-slate-200'; switch(p.estado?p.estado.toLowerCase():''){case 'borrador':eBg='bg-blue-100 text-blue-700 dark:bg-blue-700 dark:text-blue-100';break;case 'programada':eBg='bg-indigo-100 text-indigo-700 dark:bg-indigo-700 dark:text-indigo-100';break;case 'revisión cliente':eBg='bg-yellow-100 text-yellow-700 dark:bg-yellow-600 dark:text-yellow-100';break;case 'aprobada':eBg='bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100';break;case 'publicada':eBg='bg-success text-white dark:bg-green-600';break;case 'rechazada':eBg='bg-danger text-white dark:bg-red-600';break;} tr.innerHTML=`<td class="text-brand-text-secondary dark:text-slate-400">${p.clienteNombre||clientes_data.find(c=>c.id===p.clienteId)?.nombre||'N/A'}</td><td class="text-brand-text-secondary dark:text-slate-400">${p.redSocial||'-'}</td><td class="text-brand-text-primary dark:text-slate-200 text-sm">${ext}</td><td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(p.fechaPublicacion)||'-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${p.horaPublicacion||'-'}</td><td><span class="px-2 py-1 text-xs font-semibold rounded-full ${eBg}">${p.estado||'-'}</span></td><td class="text-right text-sm font-medium"><button data-id="${p.id}" class="editar-publicacion-btn font-semibold mr-3 text-brand-primary hover:text-brand-primary-hover dark:text-primary-light dark:hover:text-blue-300">Editar</button><button data-id="${p.id}" class="eliminar-publicacion-btn font-semibold text-danger hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Eliminar</button></td>`;tablaPublicacionesBody.appendChild(tr);});} setupPaginacionPublicaciones(listaCompleta.length); paginacionPublicacionesContainer.style.display = listaCompleta.length > 0 ? 'flex' : 'none'; document.querySelectorAll('.editar-publicacion-btn').forEach(b=>b.addEventListener('click',handleAbrirModalEditarPublicacion)); document.querySelectorAll('.eliminar-publicacion-btn').forEach(b=>b.addEventListener('click',handleEliminarPublicacion));}
            function setupPaginacionPublicaciones(totalItems) { if (!numerosPaginaPublicacionesEl || !btnPrevPublicaciones || !btnNextPublicaciones) return; const totalPages = Math.ceil(totalItems / itemsPerPagePublicaciones); numerosPaginaPublicacionesEl.innerHTML = ''; if (totalPages > 0) { numerosPaginaPublicacionesEl.textContent = `Página ${currentPagePublicaciones} de ${totalPages}`; } else { numerosPaginaPublicacionesEl.textContent = ''; } btnPrevPublicaciones.disabled = currentPagePublicaciones === 1; btnNextPublicaciones.disabled = currentPagePublicaciones === totalPages || totalPages === 0; }
            if (btnPrevPublicaciones) btnPrevPublicaciones.addEventListener('click', () => { if (currentPagePublicaciones > 1) { currentPagePublicaciones--; aplicarFiltrosPublicaciones(); }});
            if (btnNextPublicaciones) btnNextPublicaciones.addEventListener('click', () => { const totalItemsFiltrados = obtenerPublicacionesFiltradas().length; const totalPages = Math.ceil(totalItemsFiltrados / itemsPerPagePublicaciones); if (currentPagePublicaciones < totalPages) { currentPagePublicaciones++; aplicarFiltrosPublicaciones(); }});
            function obtenerPublicacionesFiltradas() { if(!filtroPublicacionesClienteSelect || !filtroPublicacionesEstadoSelect) return publicaciones_data; const clienteIdFiltro = filtroPublicacionesClienteSelect.value; const estadoFiltro = filtroPublicacionesEstadoSelect.value; let filtradas = publicaciones_data; if (clienteIdFiltro) filtradas = filtradas.filter(p => p.clienteId === clienteIdFiltro); if (estadoFiltro) filtradas = filtradas.filter(p => p.estado === estadoFiltro); return filtradas;}
            function aplicarFiltrosPublicaciones() { currentPagePublicaciones = 1; const listaFiltrada = obtenerPublicacionesFiltradas(); renderizarTablaPublicaciones(listaFiltrada); }
            if(filtroPublicacionesClienteSelect) filtroPublicacionesClienteSelect.addEventListener('change', aplicarFiltrosPublicaciones);
            if(filtroPublicacionesEstadoSelect) filtroPublicacionesEstadoSelect.addEventListener('change', aplicarFiltrosPublicaciones);
            function abrirModalPublicacion(esEdicion=false, pubId=null){ formPublicacion.reset(); poblarSelectoresClientePublicaciones(); editandoPublicacionId=null; document.getElementById('contenidoTextoPublicacion').focus(); if(esEdicion&&pubId){const pub=publicaciones_data.find(p=>p.id===pubId); if(pub){modalPublicacionTitle.textContent='Editar Publicación'; editandoPublicacionId=pubId; document.getElementById('clientePublicacion').value=pub.clienteId||''; document.getElementById('redSocialPublicacion').value=pub.redSocial||''; document.getElementById('fechaPublicacion').value=pub.fechaPublicacion||''; document.getElementById('horaPublicacion').value=pub.horaPublicacion||''; document.getElementById('tipoContenidoPublicacion').value=pub.tipoContenido||''; document.getElementById('estadoPublicacion').value=pub.estado||'Borrador'; document.getElementById('contenidoTextoPublicacion').value=pub.contenidoTexto||''; document.getElementById('enlaceMediaPublicacion').value=pub.enlaceMedia||''; document.getElementById('notasInternasPublicacion').value=pub.notasInternas||'';}else{showToast("Publicación no encontrada.","error");return;}}else{modalPublicacionTitle.textContent='Añadir Publicación';} modalPublicacion.classList.add('active');void modalPublicacion.offsetWidth;modalPublicacionContent.style.transform='translateY(0)';}
            function cerrarModalPublicacion(){ modalPublicacionContent.style.transform='translateY(-20px)';setTimeout(()=>{modalPublicacion.classList.remove('active'); formPublicacion.reset(); editandoPublicacionId=null;},300);}
            if(btnAbrirModalPublicacion)btnAbrirModalPublicacion.addEventListener('click',()=>abrirModalPublicacion()); if(btnCerrarModalPublicacion)btnCerrarModalPublicacion.addEventListener('click',cerrarModalPublicacion); if(btnCancelarModalPublicacion)btnCancelarModalPublicacion.addEventListener('click',cerrarModalPublicacion); if(modalPublicacion)modalPublicacion.addEventListener('click',(e)=>{if(e.target===modalPublicacion&&!modalPublicacionContent.contains(e.target))cerrarModalPublicacion();});
            formPublicacion.addEventListener('submit',async(e)=>{ e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try {const cId=document.getElementById('clientePublicacion').value; const fP=document.getElementById('fechaPublicacion').value; const cont=document.getElementById('contenidoTextoPublicacion').value.trim(); const rS=document.getElementById('redSocialPublicacion').value; if(!cId||!fP||!cont||!rS){showToast("Cliente, Red, Fecha y Contenido son obligatorios.","warning"); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; document.getElementById('clientePublicacion').focus(); return;} const cS=clientes_data.find(c=>c.id===cId); const dP={id:editandoPublicacionId,clienteId:cId,clienteNombre:cS?cS.nombre:'',redSocial:rS,fechaPublicacion:fP,horaPublicacion:document.getElementById('horaPublicacion').value,contenidoTexto:cont,enlaceMedia:document.getElementById('enlaceMediaPublicacion').value.trim(),tipoContenido:document.getElementById('tipoContenidoPublicacion').value.trim(),estado:document.getElementById('estadoPublicacion').value,notasInternas:document.getElementById('notasInternasPublicacion').value.trim(),}; const guardadoOK = await guardarPublicacionEnSheets(dP); if(guardadoOK){showToast(editandoPublicacionId?"Publicación actualizada":"Publicación añadida","success");aplicarFiltrosPublicaciones();cerrarModalPublicacion();}} catch(error){console.error("Error submit formPublicacion:", error); showToast("Ocurrió un error.", "error");} finally {submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});
            function handleAbrirModalEditarPublicacion(e){const pubId=e.target.dataset.id; abrirModalPublicacion(true,pubId);}
            async function handleEliminarPublicacion(e){const pubId=e.target.dataset.id; const pub=publicaciones_data.find(p=>p.id===pubId); if(pub){mostrarModalConfirmacion("Confirmar Eliminación", `¿Eliminar publicación para ${pub.clienteNombre||'N/A'} del ${formatLocalDate(pub.fechaPublicacion)}?`, async () => {const elimOK=await eliminarPublicacionDeSheets(pubId); if(elimOK){showToast("Publicación eliminada","success");aplicarFiltrosPublicaciones();}}, "Eliminar Publicación", "bg-danger hover:bg-red-700");}}

            function abrirModalPaqueteServicio() { formPaqueteServicio.reset(); document.getElementById('nombrePaquete').focus(); modalPaqueteServicio.classList.add('active'); void modalPaqueteServicio.offsetWidth; modalPaqueteServicioContent.style.transform = 'translateY(0)'; }
            function cerrarModalPaqueteServicio() { modalPaqueteServicioContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalPaqueteServicio.classList.remove('active'); formPaqueteServicio.reset(); }, 300); }
            if(btnAbrirModalPaqueteServicio) btnAbrirModalPaqueteServicio.addEventListener('click', abrirModalPaqueteServicio);
            if(btnCerrarModalPaqueteServicio) btnCerrarModalPaqueteServicio.addEventListener('click', cerrarModalPaqueteServicio);
            if(btnCancelarModalPaqueteServicio) btnCancelarModalPaqueteServicio.addEventListener('click', cerrarModalPaqueteServicio);
            if(modalPaqueteServicio) modalPaqueteServicio.addEventListener('click', (e) => { if (e.target === modalPaqueteServicio && !modalPaqueteServicioContent.contains(e.target)) cerrarModalPaqueteServicio(); });
            formPaqueteServicio.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try { const nombre = document.getElementById('nombrePaquete').value.trim(); if (!nombre) { showToast("Nombre del paquete obligatorio.", "warning"); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; document.getElementById('nombrePaquete').focus(); return; } const datosPaquete = { nombre: nombre, categoria: document.getElementById('categoriaPaquete').value.trim(), descripcion: document.getElementById('descripcionPaquete').value.trim(), precioSugerido: parseFloat(document.getElementById('precioSugeridoPaquete').value) || null }; const guardadoExitoso = await guardarPaqueteServicioEnSheets(datosPaquete); if (guardadoExitoso) { showToast("Paquete de servicio añadido", "success"); renderizarPaquetesServicios(); poblarSelectPaquetesServicio(); cerrarModalPaqueteServicio(); }} catch (error) {console.error("Error submit formPaqueteServicio:", error); showToast("Ocurrió un error.", "error");} finally {submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});

            function poblarSelectorClienteIngresos() { const selects = [clienteIngresoSelect, filtroIngresosClienteSelect]; selects.forEach(selectEl => { if (!selectEl) return; const currentValue = selectEl.value; const firstOptionText = selectEl === filtroIngresosClienteSelect ? "Todos los Clientes" : "-- Seleccione Cliente --"; selectEl.innerHTML = `<option value="">${firstOptionText}</option>`; clientes_data.forEach(cliente => { const option = document.createElement('option'); option.value = cliente.id; option.textContent = cliente.nombre; selectEl.appendChild(option); }); if (clientes_data.find(c => c.id === currentValue)) { selectEl.value = currentValue;} else if (selectEl === filtroIngresosClienteSelect) {selectEl.value = "";}}); if(referenciaPaqueteIngresoSelect) { const currentPkgVal = referenciaPaqueteIngresoSelect.value; referenciaPaqueteIngresoSelect.innerHTML = '<option value="">-- Ningún Paquete Específico --</option>'; paquetes_servicios_data.forEach(paquete => { const option = document.createElement('option'); option.value = paquete.id; option.textContent = paquete.nombre; referenciaPaqueteIngresoSelect.appendChild(option); }); if(paquetes_servicios_data.find(p => p.id === currentPkgVal)) referenciaPaqueteIngresoSelect.value = currentPkgVal;}}
            function renderizarTablaIngresos(listaFiltrada = ingresos_data) { if (!tablaIngresosBody) return; tablaIngresosBody.innerHTML = ''; let totalVisualizado = 0; if (listaFiltrada.length === 0) { tablaIngresosBody.innerHTML = `<tr><td colspan="6" class="text-center text-sm text-brand-text-secondary dark:text-slate-400 py-4">No hay ingresos que coincidan.</td></tr>`; if(totalIngresosVisualizadosEl) totalIngresosVisualizadosEl.textContent = "$0.00"; return; } listaFiltrada.sort((a, b) => new Date(b.fechaPago) - new Date(a.fechaPago)); listaFiltrada.forEach(ingreso => { const tr = document.createElement('tr'); totalVisualizado += parseFloat(ingreso.monto || 0); tr.innerHTML = `<td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(ingreso.fechaPago) || '-'}</td><td class="text-brand-text-primary dark:text-slate-200 font-medium">${ingreso.clienteNombre || clientes_data.find(c=>c.id === ingreso.clienteId)?.nombre || 'N/A'}</td><td class="text-brand-text-secondary dark:text-slate-400">${ingreso.concepto || '-'}</td><td class="text-success dark:text-green-400 font-semibold">$${(parseFloat(ingreso.monto) || 0).toFixed(2)}</td><td class="text-brand-text-secondary dark:text-slate-400">${ingreso.metodoPago || '-'}</td><td class="text-right text-sm font-medium"><button data-id="${ingreso.id}" class="eliminar-ingreso-btn font-semibold text-danger hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Eliminar</button></td>`; tablaIngresosBody.appendChild(tr); }); if(totalIngresosVisualizadosEl) totalIngresosVisualizadosEl.textContent = `$${totalVisualizado.toFixed(2)}`; document.querySelectorAll('.eliminar-ingreso-btn').forEach(btn => btn.addEventListener('click', handleEliminarIngreso)); }
            function aplicarFiltrosIngresos() { if(!filtroIngresosClienteSelect || !filtroIngresosMesInput) return; const clienteIdFiltro = filtroIngresosClienteSelect.value; const mesFiltro = filtroIngresosMesInput.value; let filtrados = ingresos_data; if (clienteIdFiltro) filtrados = filtrados.filter(i => i.clienteId === clienteIdFiltro); if (mesFiltro) filtrados = filtrados.filter(i => i.fechaPago && i.fechaPago.startsWith(mesFiltro)); renderizarTablaIngresos(filtrados); }
            if(filtroIngresosClienteSelect) filtroIngresosClienteSelect.addEventListener('change', aplicarFiltrosIngresos);
            if(filtroIngresosMesInput) filtroIngresosMesInput.addEventListener('change', aplicarFiltrosIngresos);
            function abrirModalIngreso() { formIngreso.reset(); poblarSelectorClienteIngresos(); document.getElementById('clienteIngreso').focus(); modalIngreso.classList.add('active'); void modalIngreso.offsetWidth; modalIngresoContent.style.transform = 'translateY(0)'; }
            function cerrarModalIngreso() { modalIngresoContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalIngreso.classList.remove('active'); formIngreso.reset();}, 300); }
            if(btnAbrirModalIngreso) btnAbrirModalIngreso.addEventListener('click', abrirModalIngreso); if(btnCerrarModalIngreso) btnCerrarModalIngreso.addEventListener('click', cerrarModalIngreso); if(btnCancelarModalIngreso) btnCancelarModalIngreso.addEventListener('click', cerrarModalIngreso); if(modalIngreso) modalIngreso.addEventListener('click', (e) => { if (e.target === modalIngreso && !modalIngresoContent.contains(e.target)) cerrarModalIngreso(); });
            formIngreso.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try {const clienteId = document.getElementById('clienteIngreso').value; const fechaPago = document.getElementById('fechaPagoIngreso').value; const monto = parseFloat(document.getElementById('montoIngreso').value); const concepto = document.getElementById('conceptoIngreso').value.trim(); if (!clienteId || !fechaPago || !monto || monto <= 0 || !concepto) { showToast("Cliente, Fecha, Monto y Concepto obligatorios.", "warning"); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; return; } const clienteSel = clientes_data.find(c => c.id === clienteId); const datosIngreso = { clienteId: clienteId, clienteNombre: clienteSel ? clienteSel.nombre : '', fechaPago: fechaPago, monto: monto, concepto: concepto, metodoPago: document.getElementById('metodoPagoIngreso').value, referenciaPaqueteId: document.getElementById('referenciaPaqueteIngreso').value || null, notas: document.getElementById('notasIngreso').value.trim() }; const guardadoOK = await guardarIngresoEnSheets(datosIngreso); if (guardadoOK) { showToast("Ingreso registrado", "success"); aplicarFiltrosIngresos(); cerrarModalIngreso(); }} catch (error) {console.error("Error submit formIngreso:", error); showToast("Ocurrió un error.", "error");} finally { submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});
            async function handleEliminarIngreso(e) { const ingId = e.target.dataset.id; const ing = ingresos_data.find(i => i.id === ingId); if (ing) { mostrarModalConfirmacion("Confirmar Eliminación", `¿Eliminar ingreso de ${ing.clienteNombre||'N/A'} por $${ing.monto} (${ing.concepto})?`, async () => {const elimOK = await eliminarIngresoDeSheets(ingId); if (elimOK) { showToast("Ingreso eliminado", "success"); aplicarFiltrosIngresos(); }}, "Eliminar Ingreso", "bg-danger hover:bg-red-700");}}

            function poblarSelectorClienteCuentasCobrar() { const selects = [clienteCuentaCobrarSelect, filtroCuentasCobrarClienteSelect]; selects.forEach(selectEl => { if (!selectEl) return; const currentValue = selectEl.value; const firstOptionText = selectEl === filtroCuentasCobrarClienteSelect ? "Todos los Clientes" : "-- Seleccione Cliente --"; selectEl.innerHTML = `<option value="">${firstOptionText}</option>`; clientes_data.forEach(cliente => { const option = document.createElement('option'); option.value = cliente.id; option.textContent = cliente.nombre; selectEl.appendChild(option); }); if (clientes_data.find(c => c.id === currentValue)) selectEl.value = currentValue; else if (selectEl === filtroCuentasCobrarClienteSelect) selectEl.value = ""; }); }
            function renderizarTablaCuentasCobrar(listaFiltrada = cuentas_cobrar_data) { if (!tablaCuentasCobrarBody) return; tablaCuentasCobrarBody.innerHTML = ''; let totalSaldoPendiente = 0; if (listaFiltrada.length === 0) { tablaCuentasCobrarBody.innerHTML = `<tr><td colspan="9" class="text-center text-sm text-brand-text-secondary dark:text-slate-400 py-4">No hay cuentas por cobrar que coincidan.</td></tr>`; if(totalSaldoPendienteVisualizadoEl) totalSaldoPendienteVisualizadoEl.textContent = "$0.00"; return; } listaFiltrada.sort((a, b) => { const estadoOrder = { "Vencida": 1, "Pendiente": 2, "Pagada Parcialmente": 3, "Pagada": 4, "Cancelada": 5 }; const estadoA = estadoOrder[a.estado] || 6; const estadoB = estadoOrder[b.estado] || 6; if (estadoA !== estadoB) return estadoA - estadoB; const dateA = a.fechaVencimiento ? new Date(a.fechaVencimiento) : new Date(a.fechaEmision); const dateB = b.fechaVencimiento ? new Date(b.fechaVencimiento) : new Date(b.fechaEmision); return dateA - dateB; }); listaFiltrada.forEach(cc => { const tr = document.createElement('tr'); const montoTotal = parseFloat(cc.monto || 0); const montoPagado = parseFloat(cc.montoPagado || 0); const saldo = montoTotal - montoPagado; if (cc.estado !== "Pagada" && cc.estado !== "Cancelada") totalSaldoPendiente += saldo; let estadoClass = 'bg-gray-200 text-gray-700 dark:bg-slate-600 dark:text-slate-200'; switch(cc.estado) { case 'Pendiente': estadoClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-600 dark:text-yellow-100'; break; case 'Pagada Parcialmente': estadoClass = 'bg-blue-100 text-blue-700 dark:bg-blue-700 dark:text-blue-100'; break; case 'Pagada': estadoClass = 'bg-success text-white dark:bg-green-600 dark:text-green-100'; break; case 'Vencida': estadoClass = 'bg-danger text-white dark:bg-red-600 dark:text-red-100'; break; case 'Cancelada': estadoClass = 'bg-gray-400 text-white dark:bg-slate-500 dark:text-slate-200'; break;} tr.innerHTML = `<td class="text-brand-text-primary dark:text-slate-200 font-medium">${cc.clienteNombre || clientes_data.find(c=>c.id === cc.clienteId)?.nombre || 'N/A'}</td><td class="text-brand-text-secondary dark:text-slate-400">${cc.concepto || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">$${montoTotal.toFixed(2)}</td><td class="text-brand-text-secondary dark:text-slate-400">$${montoPagado.toFixed(2)}</td><td class="font-semibold ${saldo > 0 ? 'text-warning dark:text-yellow-400' : 'text-success dark:text-green-400'}">$${saldo.toFixed(2)}</td><td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(cc.fechaEmision) || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${formatLocalDate(cc.fechaVencimiento) || '-'}</td><td><span class="px-2 py-1 text-xs font-semibold rounded-full ${estadoClass}">${cc.estado || '-'}</span></td><td class="text-right text-sm font-medium"><button data-id="${cc.id}" class="eliminar-cuentacobrar-btn font-semibold text-danger hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Eliminar</button></td>`; tablaCuentasCobrarBody.appendChild(tr); }); if(totalSaldoPendienteVisualizadoEl) totalSaldoPendienteVisualizadoEl.textContent = `$${totalSaldoPendiente.toFixed(2)}`; document.querySelectorAll('.eliminar-cuentacobrar-btn').forEach(btn => btn.addEventListener('click', handleEliminarCuentaCobrar)); }
            function aplicarFiltrosCuentasCobrar() { if(!filtroCuentasCobrarClienteSelect || !filtroCuentasCobrarEstadoSelect) return; const clienteIdFiltro = filtroCuentasCobrarClienteSelect.value; const estadoFiltro = filtroCuentasCobrarEstadoSelect.value; let filtrados = cuentas_cobrar_data; if (clienteIdFiltro) filtrados = filtrados.filter(cc => cc.clienteId === clienteIdFiltro); if (estadoFiltro) filtrados = filtrados.filter(cc => cc.estado === estadoFiltro); renderizarTablaCuentasCobrar(filtrados); }
            if(filtroCuentasCobrarClienteSelect) filtroCuentasCobrarClienteSelect.addEventListener('change', aplicarFiltrosCuentasCobrar);
            if(filtroCuentasCobrarEstadoSelect) filtroCuentasCobrarEstadoSelect.addEventListener('change', aplicarFiltrosCuentasCobrar);
            function abrirModalCuentaCobrar() { formCuentaCobrar.reset(); poblarSelectorClienteCuentasCobrar(); document.getElementById('montoPagadoCuentaCobrar').value = "0"; document.getElementById('estadoCuentaCobrar').value = "Pendiente"; document.getElementById('clienteCuentaCobrar').focus(); modalCuentaCobrar.classList.add('active'); void modalCuentaCobrar.offsetWidth; modalCuentaCobrarContent.style.transform = 'translateY(0)'; }
            function cerrarModalCuentaCobrar() { modalCuentaCobrarContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalCuentaCobrar.classList.remove('active'); formCuentaCobrar.reset(); editandoCuentaCobrarId = null; }, 300); }
            if(btnAbrirModalCuentaCobrar) btnAbrirModalCuentaCobrar.addEventListener('click', abrirModalCuentaCobrar); if(btnCerrarModalCuentaCobrar) btnCerrarModalCuentaCobrar.addEventListener('click', cerrarModalCuentaCobrar); if(btnCancelarModalCuentaCobrar) btnCancelarModalCuentaCobrar.addEventListener('click', cerrarModalCuentaCobrar); if(modalCuentaCobrar) modalCuentaCobrar.addEventListener('click', (e) => { if (e.target === modalCuentaCobrar && !modalCuentaCobrarContent.contains(e.target)) cerrarModalCuentaCobrar(); });
            formCuentaCobrar.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try{ const clienteId = document.getElementById('clienteCuentaCobrar').value; const concepto = document.getElementById('conceptoCuentaCobrar').value.trim(); const monto = parseFloat(document.getElementById('montoCuentaCobrar').value); const fechaEmision = document.getElementById('fechaEmisionCuentaCobrar').value; if (!clienteId || !concepto || !monto || monto <= 0 || !fechaEmision) { showToast("Cliente, Concepto, Monto y Fecha Emisión obligatorios.", "warning"); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; document.getElementById('clienteCuentaCobrar').focus();return; } const clienteSel = clientes_data.find(c => c.id === clienteId); const datosCuenta = { id:editandoCuentaCobrarId, clienteId: clienteId, clienteNombre: clienteSel ? clienteSel.nombre : '', concepto: concepto, monto: monto, montoPagado: parseFloat(document.getElementById('montoPagadoCuentaCobrar').value) || 0, fechaEmision: fechaEmision, fechaVencimiento: document.getElementById('fechaVencimientoCuentaCobrar').value || null, estado: document.getElementById('estadoCuentaCobrar').value, fechaUltimoPago: document.getElementById('fechaUltimoPagoCuentaCobrar').value || null, notas: document.getElementById('notasCuentaCobrar').value.trim() }; const guardadoOK = await guardarCuentaPorCobrarEnSheets(datosCuenta); if (guardadoOK) { showToast("Cuenta por cobrar guardada", "success"); aplicarFiltrosCuentasCobrar(); cerrarModalCuentaCobrar(); }} catch (error) {console.error("Error submit formCuentaCobrar:", error); showToast("Ocurrió un error.", "error");} finally { submitButton.disabled = false; submitButton.innerHTML = originalButtonText;} });
            async function handleEliminarCuentaCobrar(e) { const cuentaId = e.target.dataset.id; const cuenta = cuentas_cobrar_data.find(cc => cc.id === cuentaId); if (cuenta) { mostrarModalConfirmacion("Confirmar Eliminación", `¿Eliminar cuenta por cobrar para ${cuenta.clienteNombre||'N/A'} de $${cuenta.monto} (${cuenta.concepto})?`, async () => {const elimOK = await eliminarCuentaPorCobrarDeSheets(cuentaId); if (elimOK) { showToast("Cuenta por cobrar eliminada", "success"); aplicarFiltrosCuentasCobrar(); }}, "Eliminar Cuenta", "bg-danger hover:bg-red-700"); } }

            function renderizarTablaCuentasEmpresa(lista = cuentas_empresa_data) { if(!tablaCuentasEmpresaBody) return; tablaCuentasEmpresaBody.innerHTML = ''; if (lista.length === 0) { tablaCuentasEmpresaBody.innerHTML = `<tr><td colspan="6" class="text-center text-sm text-brand-text-secondary dark:text-slate-400 py-4">No hay cuentas de empresa registradas.</td></tr>`; return; } lista.forEach(cuenta => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="text-brand-text-primary dark:text-slate-200 font-medium">${cuenta.nombreEntidad || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${cuenta.tipoCuenta || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${cuenta.identificadorCuenta || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${cuenta.titular || '-'}</td><td class="text-brand-text-secondary dark:text-slate-400">${cuenta.moneda || '-'}</td><td class="text-right text-sm font-medium"><button data-id="${cuenta.id}" class="eliminar-cuentaempresa-btn font-semibold text-danger hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Eliminar</button></td>`; tablaCuentasEmpresaBody.appendChild(tr);}); document.querySelectorAll('.eliminar-cuentaempresa-btn').forEach(btn => btn.addEventListener('click', handleEliminarCuentaEmpresa));}
            function abrirModalCuentaEmpresa() { formCuentaEmpresa.reset(); document.getElementById('nombreEntidadCuentaEmpresa').focus(); modalCuentaEmpresa.classList.add('active'); void modalCuentaEmpresa.offsetWidth; modalCuentaEmpresaContent.style.transform = 'translateY(0)'; }
            function cerrarModalCuentaEmpresa() { modalCuentaEmpresaContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalCuentaEmpresa.classList.remove('active'); formCuentaEmpresa.reset(); editandoCuentaEmpresaId = null;}, 300); }
            if(btnAbrirModalCuentaEmpresa) btnAbrirModalCuentaEmpresa.addEventListener('click', abrirModalCuentaEmpresa);
            if(btnCerrarModalCuentaEmpresa) btnCerrarModalCuentaEmpresa.addEventListener('click', cerrarModalCuentaEmpresa);
            if(btnCancelarModalCuentaEmpresa) btnCancelarModalCuentaEmpresa.addEventListener('click', cerrarModalCuentaEmpresa);
            if(modalCuentaEmpresa) modalCuentaEmpresa.addEventListener('click', (e) => { if (e.target === modalCuentaEmpresa && !modalCuentaEmpresaContent.contains(e.target)) cerrarModalCuentaEmpresa(); });
            formCuentaEmpresa.addEventListener('submit', async (e) => { e.preventDefault(); const submitButton = e.submitter; const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Guardando...`; try { const nombreEntidad = document.getElementById('nombreEntidadCuentaEmpresa').value.trim(); const tipoCuenta = document.getElementById('tipoCuentaEmpresa').value.trim(); const identificador = document.getElementById('identificadorCuentaEmpresa').value.trim(); if(!nombreEntidad || !tipoCuenta || !identificador) { showToast("Nombre entidad, Tipo e Identificador son obligatorios.", "warning"); submitButton.disabled = false; submitButton.innerHTML = originalButtonText; document.getElementById('nombreEntidadCuentaEmpresa').focus(); return;} const datosCuenta = { id: editandoCuentaEmpresaId, nombreEntidad: nombreEntidad, tipoCuenta: tipoCuenta, identificadorCuenta: identificador, titular: document.getElementById('titularCuentaEmpresa').value.trim(), moneda: document.getElementById('monedaCuentaEmpresa').value.trim(), notasConfidenciales: document.getElementById('notasConfidencialesCuentaEmpresa').value.trim() }; const guardadoOK = await guardarCuentaEmpresaEnSheets(datosCuenta); if(guardadoOK) { showToast("Cuenta de empresa guardada.", "success"); renderizarTablaCuentasEmpresa(cuentas_empresa_data); cerrarModalCuentaEmpresa(); }} catch (error) { console.error("Error submit formCuentaEmpresa:", error); showToast("Ocurrió un error.", "error");} finally { submitButton.disabled = false; submitButton.innerHTML = originalButtonText;}});
            async function handleEliminarCuentaEmpresa(e) { const cuentaId = e.target.dataset.id; const cuenta = cuentas_empresa_data.find(ce => ce.id === cuentaId); if (cuenta) { mostrarModalConfirmacion("Confirmar Eliminación", `¿Eliminar cuenta "${cuenta.nombreEntidad} - ${cuenta.identificadorCuenta}"?`, async () => {const elimOK = await eliminarCuentaEmpresaDeSheets(cuentaId); if (elimOK) { showToast("Cuenta de empresa eliminada", "success"); renderizarTablaCuentasEmpresa(cuentas_empresa_data); }}, "Eliminar Cuenta", "bg-danger hover:bg-red-700");}}


            function mostrarModalConfirmacion(title, message, onConfirmCallback, confirmButtonText = "Confirmar", confirmButtonClass = "bg-danger hover:bg-red-700") { modalConfirmacionTitleEl.textContent = title; modalConfirmacionMessageEl.textContent = message; confirmacionCallback = onConfirmCallback; btnConfirmarModalAccion.textContent = confirmButtonText; btnConfirmarModalAccion.className = 'btn btn-primary-modern'; confirmButtonClass.split(" ").forEach(cls => { if(cls.trim()) btnConfirmarModalAccion.classList.add(cls.trim()); }); modalConfirmacion.classList.add('active'); void modalConfirmacion.offsetWidth; modalConfirmacionContent.style.transform = 'translateY(0)'; }
            function cerrarModalConfirmacion() { modalConfirmacionContent.style.transform = 'translateY(-20px)'; setTimeout(() => { modalConfirmacion.classList.remove('active'); confirmacionCallback = null; }, 300); }
            btnConfirmarModalAccion.addEventListener('click', () => { if (typeof confirmacionCallback === 'function') { confirmacionCallback(); } cerrarModalConfirmacion(); });
            btnCancelarModalConfirmacion.addEventListener('click', cerrarModalConfirmacion);
            modalConfirmacion.addEventListener('click', (e) => { if (e.target === modalConfirmacion && !modalConfirmacionContent.contains(e.target)) cerrarModalConfirmacion(); });

            if(btnVerCalendarioCompleto) { btnVerCalendarioCompleto.addEventListener('click', () => { const googleCalendarWebViewUrl = `https://calendar.google.com/calendar/u/0/r?cid=${encodeURIComponent(GOOGLE_CALENDAR_ID_FOR_VIEW)}`; window.open(googleCalendarWebViewUrl, '_blank'); }); }

            if(buscadorClientesInput) buscadorClientesInput.addEventListener('input', function() { const t=this.value.toLowerCase().trim(); if(t==="")renderizarClientesResumen(clientes_data); else{const f=clientes_data.filter(c=>c.nombre.toLowerCase().includes(t));renderizarClientesResumen(f);}});
            
            function exportToCSV(tipo) { let data=[],hdrs=[],fname="export.csv";if(tipo==='clientes'){if(clientes_data.length===0){showToast("No hay clientes.","info");return;}data=clientes_data;hdrs=["ID Cliente","Nombre","Clínica","Email","Teléfono","Servicios Resumen","Pagado ($)","Notas","Dominio Web","Tipo Web","Vencimiento Web","Plataformas Redes (General)","Detalles Redes (General)","Servicios Contratados (JSON)","Configuración Redes (JSON)"];fname="clientes.csv";} const esc=(f)=>{if(f==null||typeof f==='undefined')return '';let sF=String(f);if(typeof f==='object'&&f!==null)try{sF=JSON.stringify(f);}catch(e){sF='[Error]';}if(sF.includes(',')||sF.includes('\n')||sF.includes('"'))sF='"'+sF.replace(/"/g,'""')+'"';return sF;}; let csv="data:text/csv;charset=utf-8,"+hdrs.map(esc).join(",")+"\n"; data.forEach(item=>{const row=hdrs.map(h=>{if(tipo==='clientes'){switch(h){case "ID Cliente":return esc(item.id);case "Nombre":return esc(item.nombre);case "Clínica":return esc(item.clinica);case "Email":return esc(item.email);case "Teléfono":return esc(item.telefono);case "Servicios Resumen":return esc(item.serviciosActivosGeneral);case "Pagado ($)":return esc((parseFloat(item.pagado)||0).toFixed(2));case "Notas":return esc(item.notas);case "Dominio Web":return esc(item.dominioWeb);case "Tipo Web":return esc(item.tipoServicioWeb);case "Vencimiento Web":return esc(item.vencimientoWeb);case "Plataformas Redes (General)":return esc(item.plataformasRedes);case "Detalles Redes (General)":return esc(item.detallesRedes);case "Servicios Contratados (JSON)":return esc(item.serviciosContratados||[]);case "Configuración Redes (JSON)":return esc(item.configuracionRedes||{});default:return '';}}return '';});csv+=row.join(",")+"\n";}); const uri=encodeURI(csv);const link=document.createElement("a");link.setAttribute("href",uri);link.setAttribute("download",fname);document.body.appendChild(link);link.click();document.body.removeChild(link);}

            navLinks.forEach(link => { 
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const hrefAttribute = link.getAttribute('href');
                    if (hrefAttribute) {
                        const targetId = hrefAttribute.substring(1); 
                        if (targetId !== 'perfil-cliente') { 
                            clienteSeleccionadoPerfilDedicadoId = null; 
                            window.location.hash = `#${targetId}`; 
                        } 
                        if (window.innerWidth < 1024 && sidebarEl && !sidebarEl.classList.contains('-translate-x-full')) { 
                            sidebarEl.classList.add('-translate-x-full'); 
                        } 
                    } else {
                        // Este console.error ya no debería aparecer para theme-toggle y btnLogout
                        console.error("NavLink (dentro de <nav>) sin atributo href:", link);
                    }
                }); 
            });
            
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash;
                let targetId = 'dashboard'; 
                let clienteId = null;

                if (hash && hash !== '#') { 
                    if (hash.startsWith('#perfil-cliente?id=')) {
                        targetId = 'perfil-cliente';
                        clienteId = hash.substring('#perfil-cliente?id='.length);
                    } else {
                        const potentialTargetId = hash.substring(1);
                         if (document.getElementById(potentialTargetId)) { // Verificar si la sección existe
                            targetId = potentialTargetId;
                        }
                    }
                }
                
                if (targetId !== 'perfil-cliente' && !document.getElementById(targetId)) {
                    targetId = 'dashboard';
                }

                if (targetId !== 'perfil-cliente') {
                    vistaAnterior = `#${targetId}`;
                }
                showSection(targetId, clienteId);
            });

            if(btnAbrirModalCliente) btnAbrirModalCliente.addEventListener('click', () => abrirModalCliente()); 
            if(btnCerrarModalCliente) btnCerrarModalCliente.addEventListener('click', cerrarModalCliente); 
            if(btnCancelarModalCliente) btnCancelarModalCliente.addEventListener('click', cerrarModalCliente); 
            if(btnExportarCSVClientes) btnExportarCSVClientes.addEventListener('click', () => exportToCSV('clientes')); 
            if(modalCliente) modalCliente.addEventListener('click', (e) => { if (e.target === modalCliente && !modalClienteContent.contains(e.target)) cerrarModalCliente(); });
            
            if(btnAbrirModalTarea) btnAbrirModalTarea.addEventListener('click', () => abrirModalTarea()); 
            if(btnCerrarModalTarea) btnCerrarModalTarea.addEventListener('click', cerrarModalTarea); 
            if(btnCancelarModalTarea) btnCancelarModalTarea.addEventListener('click', cerrarModalTarea); 
            if(modalTarea) modalTarea.addEventListener('click', (e) => { if (e.target === modalTarea && !modalTareaContent.contains(e.target)) cerrarModalTarea(); });


            // FUNCIONES DE LOGIN/LOGOUT
            function showLoginScreen() {
                if (loginScreen) loginScreen.style.display = 'flex';
                if (mainContentWrapper) mainContentWrapper.style.display = 'none';
                if (sidebarToggleBtnEl) sidebarToggleBtnEl.style.display = 'none';
                if (loginErrorEl) loginErrorEl.classList.add('hidden');
                clientes_data = []; tareas_data = []; publicaciones_data = []; paquetes_servicios_data = [];
                ingresos_data = []; cuentas_cobrar_data = []; cuentas_empresa_data = [];
                if(tablaClientesBody) tablaClientesBody.innerHTML = ''; 
                if(tablaTareasBody) tablaTareasBody.innerHTML = '';
            }

            function showAppScreen() {
                if (loginScreen) loginScreen.style.display = 'none';
                if (mainContentWrapper) mainContentWrapper.style.display = 'flex'; 
                if (sidebarToggleBtnEl) sidebarToggleBtnEl.style.display = 'block'; 
                
                const currentHash = window.location.hash.substring(1);
                const currentSectionId = currentHash.split('?')[0]; // Para manejar #perfil-cliente?id=...

                if (!currentSectionId || !document.getElementById(currentSectionId)) {
                    if(!pageSections[0].classList.contains('hidden')) { // Si el dashboard ya está visible, no hacer nada
                         return;
                    }
                    showSection('dashboard'); 
                } else {
                    // La lógica en fetchInitialData y hashchange se encargará
                }
            }

            function clearSessionAndShowLogin() {
                localStorage.removeItem(SESSION_TOKEN_KEY);
                showLoginScreen();
            }
            
            async function checkLoginState() {
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                if (token) {
                    showAppScreen(); // Muestra la app primero
                    await fetchInitialData(); // Luego carga los datos
                } else {
                    showLoginScreen();
                }
            }
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (loginErrorEl) loginErrorEl.classList.add('hidden');
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const submitButton = loginForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = `<span class="spinner-inline" role="status" aria-hidden="true"></span>Verificando...`;

                    const result = await saveDataToSheets('loginUser', { username, password });
                    
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;

                    if (result.success && result.data && result.data.token) {
                        localStorage.setItem(SESSION_TOKEN_KEY, result.data.token);
                        showAppScreen(); // Muestra la app
                        await fetchInitialData(); // Carga los datos
                    } else {
                        if (loginErrorEl) {
                            loginErrorEl.textContent = result.error || "Usuario o contraseña incorrectos.";
                            loginErrorEl.classList.remove('hidden');
                        }
                        showToast(result.error || "Fallo el inicio de sesión", "error");
                    }
                });
            }

            if (btnLogout) {
                btnLogout.addEventListener('click', async () => {
                    showLoadingIndicator(true, "Cerrando sesión...");
                    const token = localStorage.getItem(SESSION_TOKEN_KEY);
                    if (token) {
                        await saveDataToSheets('logoutUser', { sessionToken: token }); 
                    }
                    clearSessionAndShowLogin();
                    showLoadingIndicator(false);
                    showToast("Sesión cerrada", "info");
                    window.location.hash = ''; // Opcional: Limpiar el hash para evitar que intente cargar una sección protegida
                });
            }

            checkLoginState(); 

        });
    </script>
</body>
</html>
